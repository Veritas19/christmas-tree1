<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ç²’å­åœ£è¯æ ‘ Â· æ‰‹åŠ¿äº¤äº’</title>
  <style>
    :root{
      --gold:#ffd36a; --gold2:#ffefb0;
      --red:#ff2a2a;
      --panel: rgba(0,0,0,.38);
      --stroke: rgba(255,255,255,.18);
    }
    html,body{margin:0;height:100%;overflow:hidden;background:#07070a;font-family:system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Microsoft YaHei",Arial;}
    #app{position:fixed;inset:0;}
    canvas{display:block;width:100%;height:100%;touch-action:none;}

    /* é¡¶éƒ¨é¢æ¿ */
    #hud{
      position:fixed; left:12px; top:12px; z-index:20;
      width:min(540px, calc(100vw - 24px));
      color:#fff;
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      backdrop-filter: blur(10px);
      border-radius:16px;
      padding:12px 12px 10px;
      box-shadow:0 14px 38px rgba(0,0,0,.42);
      pointer-events:auto;
    }
    #hud h1{margin:0 0 8px;font-size:14px;font-weight:900;letter-spacing:.3px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{
      cursor:pointer; user-select:none;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.22);
      color:#fff;
      padding:10px 12px;border-radius:14px;font-weight:900;
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn.primary{
      color:#1b1106;
      background:linear-gradient(180deg, #ffe39b, #f7c857);
      border:none;
      box-shadow:0 14px 32px rgba(247,200,87,.18);
    }
    .btn:active{transform:scale(.985)}
    .hint{margin-top:8px;font-size:12px;line-height:1.45;opacity:.92}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.14);font-size:12px}
    .dot{width:9px;height:9px;border-radius:99px;background:#888;box-shadow:0 0 10px rgba(255,255,255,.18)}
    .dot.on{background:#6cff9b;box-shadow:0 0 14px rgba(108,255,155,.65)}
    .dot.warn{background:#ffd36a;box-shadow:0 0 14px rgba(255,211,106,.55)}

    /* ä¸Šä¼ åŒº */
    #fileInput{display:none}
    #thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .thumb{width:42px;height:42px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.22)}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}

    /* å¼€å§‹ä½“éªŒ */
    #startOverlay{
      position:fixed; inset:0; z-index:50;
      display:grid; place-items:center;
      background:
        radial-gradient(1000px 700px at 50% 40%, rgba(255,211,106,.16), transparent 60%),
        radial-gradient(900px 650px at 50% 65%, rgba(255,42,42,.08), transparent 62%),
        linear-gradient(180deg, rgba(5,6,9,.94), rgba(0,0,0,.94));
    }
    #startCard{
      width:min(560px, calc(100vw - 28px));
      border-radius:22px;
      padding:18px 16px 14px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      backdrop-filter: blur(12px);
      box-shadow:0 24px 70px rgba(0,0,0,.55);
      text-align:center;color:#fff;
    }
    #startCard h2{margin:4px 0 10px;font-size:18px;font-weight:950;letter-spacing:.5px}
    #startCard p{margin:0 0 14px;font-size:13px;opacity:.9;line-height:1.55}
    #startBig{
      width:100%;
      border:none;
      border-radius:18px;
      padding:16px 14px;
      font-size:18px;font-weight:950;letter-spacing:.6px;
      color:#1b1106;
      background:linear-gradient(180deg, #ffe7a8, #f6c24e);
      box-shadow:0 20px 60px rgba(246,194,78,.22), inset 0 1px 0 rgba(255,255,255,.55);
      cursor:pointer;
    }
    #startBig:active{transform:scale(.99)}
    #startStatus{margin-top:10px;font-size:12px;opacity:.92;min-height:22px;white-space:pre-line}

    /* æ”¾å¤§ç…§ç‰‡ï¼šä¿è¯æ­£é¢å®Œæ•´é«˜æ¸… */
    #photoStage{position:fixed;inset:0;z-index:40;display:none;align-items:center;justify-content:center;padding:16px;background:rgba(0,0,0,.35);backdrop-filter: blur(8px);}
    #photoWrap{width:min(900px, 92vw);max-height:80vh;border-radius:20px;overflow:hidden;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.25);box-shadow:0 26px 90px rgba(0,0,0,.62)}
    #photoImg{width:100%;height:100%;max-height:80vh;object-fit:contain;display:block;background:rgba(0,0,0,.28)}
    body.photo-mode canvas{filter: blur(9px) brightness(1.08) saturate(1.12); transition:filter .18s ease;}
    body:not(.photo-mode) canvas{filter:none;transition:filter .18s ease;}

    /* Toast */
    #toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);z-index:60;display:none;
      padding:10px 12px;border-radius:14px;background:rgba(0,0,0,.62);border:1px solid rgba(255,255,255,.16);
      color:#fff;font-size:12px;max-width:min(720px, calc(100vw - 24px));text-align:center;backdrop-filter: blur(8px);}
    #video{position:fixed;left:-9999px;top:-9999px;width:2px;height:2px;opacity:0;pointer-events:none;}
  </style>
</head>

<body>
  <!-- å…œåº•ï¼šå¦‚æœè„šæœ¬æ²¡è·‘ï¼ŒæŒ‰é’®ä¹Ÿä¼šå¼¹çª—è¯´æ˜ -->
  <div id="startOverlay">
    <div id="startCard">
      <h2>âœ¨ åœ£è¯æ ‘ Â· å¼€å§‹ä½“éªŒ</h2>
      <p>ç‚¹ä¸€æ¬¡ï¼šå°è¯•æ’­æ”¾éŸ³ä¹ + æç¤ºå¼€å¯æ‘„åƒå¤´ï¼ˆç”¨äºæ‰‹åŠ¿äº¤äº’ï¼‰ã€‚</p>
      <button id="startBig"
        onclick="(window.__startExperience && window.__startExperience()) || alert('è„šæœ¬æœªåŠ è½½ï¼šè¯·ç¡®è®¤ libs/three.min.js å­˜åœ¨ä¸”æ–‡ä»¶åæ­£ç¡®ï¼Œç„¶ååˆ·æ–°é“¾æ¥ï¼ˆåŠ  ?v=999ï¼‰');">
        å¼€å§‹ä½“éªŒï¼ˆç‚¹æˆ‘ï¼‰
      </button>
      <div id="startStatus">ç­‰å¾…å¯åŠ¨â€¦</div>
    </div>
  </div>

  <div id="app"></div>

  <div id="hud">
    <h1>ğŸ„ ç²’å­åœ£è¯æ ‘ Â· æ‰‹åŠ¿äº¤äº’</h1>
    <div class="row" style="margin-bottom:6px">
      <span class="badge"><span id="dotThree" class="dot warn"></span>Threeï¼š<b id="txtThree">æ£€æµ‹ä¸­</b></span>
      <span class="badge"><span id="dotCam" class="dot warn"></span>æ‘„åƒå¤´ï¼š<b id="txtCam">æœªå¼€å¯</b></span>
      <span class="badge"><span id="dotBgm" class="dot warn"></span>éŸ³ä¹ï¼š<b id="txtBgm">æœªå¼€å¯</b></span>
      <span class="badge"><span id="dotHand" class="dot warn"></span>æ‰‹åŠ¿ï¼š<b id="txtHand">å¾…å¯åŠ¨</b></span>
    </div>

    <div class="row">
      <button class="btn primary" id="btnCompact" type="button">åˆæ‹¢æ€</button>
      <button class="btn primary" id="btnScatter" type="button">æ•£å¼€æ€</button>
      <button class="btn" id="btnReplay" type="button">é‡æ–°æ’­æ”¾éŸ³ä¹</button>
      <button class="btn" id="btnRecam" type="button">é‡æ–°å¼€å¯æ‘„åƒå¤´</button>
      <button class="btn" id="btnPick" type="button">ä¸Šä¼ ç…§ç‰‡(â‰¤7)</button>
      <input id="fileInput" type="file" accept="image/*" multiple />
      <span id="fileHint" style="font-size:12px;opacity:.9">æœªé€‰æ‹©æ–‡ä»¶</span>
    </div>

    <div id="thumbs"></div>

    <div class="hint">
      æ‰‹åŠ¿ï¼šæ¡æ‹³â†’åˆæ‹¢ï¼›äº”æŒ‡å¼ å¼€â†’æ•£å¼€ï¼›æ•£å¼€æ—¶ç§»åŠ¨æ‰‹â†’æ—‹è½¬è§†è§’ï¼ˆå¹…åº¦è·Ÿéšï¼‰ã€‚<br/>
      <b>æ‹‡æŒ‡+é£ŸæŒ‡æåˆ</b>â†’æŠ“å–æ”¾å¤§ç…§ç‰‡ï¼Œåˆ†å¼€â†’å›åŸä½ã€‚<br/>
      è‹¥æ‰‹åŠ¿åº“åŠ è½½å¤±è´¥ï¼šä»å¯ç”¨æ‰‹æŒ‡/é¼ æ ‡æ‹–åŠ¨æ—‹è½¬è§†è§’ã€‚
    </div>
  </div>

  <div id="photoStage">
    <div id="photoWrap"><img id="photoImg" alt="photo" /></div>
  </div>

  <div id="toast"></div>
  <video id="video" playsinline></video>

  <script>
    // æ°¸è¿œä¸æŠ¥é”™çš„â€œå¯åŠ¨å…¥å£â€å ä½ï¼ˆåé¢ä¼šè¦†ç›–ä¸ºçœŸæ­£çš„å‡½æ•°ï¼‰
    window.__startExperience = function(){
      alert("æ­£åœ¨åŠ è½½è„šæœ¬ï¼Œè¯·ç¨ç­‰â€¦å¦‚æœä¸€ç›´æ²¡ååº”ï¼Œè¯·åˆ·æ–°é“¾æ¥ï¼ˆåŠ  ?v=999ï¼‰");
    };
  </script>

  <script>
  (function(){
    const $ = (id)=>document.getElementById(id);
    const toastEl = $("toast");
    function toast(msg, ms=2600){
      toastEl.textContent = msg;
      toastEl.style.display="block";
      clearTimeout(toast._t);
      toast._t=setTimeout(()=>toastEl.style.display="none", ms);
    }
    function setDot(id, state){
      const el=$(id);
      el.className = "dot " + (state==="on"?"on":state==="warn"?"warn":"");
    }

    const MAX_PHOTOS=7;
    const photoUrls=[];
    const photoPlanes=[];
    let selectedPlane=null;
    let pinchHolding=false;

    // éŸ³ä¹ï¼šç‰ˆæƒæ­Œä¸æä¾›ç›´é“¾ -> ä½ ä¸Šä¼  assets/jingle-bell-rock.mp3 å³å¯æ’­æ”¾
    const AUDIO_SOURCES = [
      "./assets/jingle-bell-rock.mp3", // ä½ è‡ªå·±ä¸Šä¼ ï¼ˆæƒ³è¦â€œJingle Bell Rockâ€å°±æ”¾è¿™ä¸ªï¼‰
      // å…œåº•å…¬å¼€éŸ³ä¹ï¼ˆç¡®ä¿æ‰‹æœºç«¯ä¹Ÿæœ‰å£°ï¼‰
      "https://upload.wikimedia.org/wikipedia/commons/3/32/Carol_of_the_Bells_-_Concert_Band_-_United_States_Air_Force_Band_of_the_Rockies.mp3"
    ];
    let audioEl=null, audioCtx=null, gainNode=null;
    async function playBGM(){
      try{
        if(!audioEl){
          audioEl = new Audio();
          audioEl.loop = true;
          audioEl.preload = "auto";
          audioEl.crossOrigin = "anonymous";
        }
        if(!audioCtx){
          audioCtx = new (window.AudioContext||window.webkitAudioContext)();
          const src = audioCtx.createMediaElementSource(audioEl);
          gainNode = audioCtx.createGain();
          gainNode.gain.value = 0.0;
          src.connect(gainNode).connect(audioCtx.destination);
        }
        await audioCtx.resume();

        let ok=false;
        for(const s of AUDIO_SOURCES){
          try{
            audioEl.src=s;
            await audioEl.play();
            ok=true;
            break;
          }catch(e){}
        }
        if(!ok) throw new Error("éŸ³ä¹æ’­æ”¾å¤±è´¥ï¼ˆæµè§ˆå™¨ç­–ç•¥æˆ–ç½‘ç»œæ‹¦æˆªï¼‰");

        const target=0.65;
        const t0=performance.now();
        const fade=(t)=>{
          const p=Math.min(1,(t-t0)/900);
          const s=p*p*(3-2*p);
          gainNode.gain.value = target*s;
          if(p<1) requestAnimationFrame(fade);
        };
        requestAnimationFrame(fade);

        setDot("dotBgm","on"); $("txtBgm").textContent="å¼€å¯";
        return true;
      }catch(e){
        setDot("dotBgm","warn"); $("txtBgm").textContent="æœªå¼€å¯";
        toast("éŸ³ä¹æ²¡æ’­æ”¾å‡ºæ¥ï¼šå†ç‚¹ä¸€æ¬¡â€œé‡æ–°æ’­æ”¾éŸ³ä¹â€è¯•è¯•ï¼ˆæ‰‹æœºé™éŸ³ä¹Ÿä¼šå½±å“ï¼‰", 3600);
        return false;
      }
    }

    // æ‘„åƒå¤´
    let stream=null;
    async function openCamera(){
      try{
        const video=$("video");
        if(stream){ try{stream.getTracks().forEach(t=>t.stop());}catch(e){} stream=null; }
        stream = await navigator.mediaDevices.getUserMedia({
          video:{ facingMode:"user", width:{ideal:960}, height:{ideal:540} },
          audio:false
        });
        video.srcObject=stream;
        await video.play();
        setDot("dotCam","on"); $("txtCam").textContent="å¼€å¯";
        return true;
      }catch(e){
        setDot("dotCam","warn"); $("txtCam").textContent="æœªå¼€å¯";
        toast("æ‘„åƒå¤´å¼€å¯å¤±è´¥ï¼šè¯·ç”¨ç³»ç»Ÿæµè§ˆå™¨æ‰“å¼€å¹¶å…è®¸æƒé™ï¼ˆå¾®ä¿¡/QQå†…ç½®æµè§ˆå™¨å¸¸å¤±è´¥ï¼‰", 4200);
        return false;
      }
    }

    // èµ„æºåŠ è½½ï¼ˆThree æœ¬åœ°ä¼˜å…ˆï¼‰
    function loadScript(url){
      return new Promise((resolve,reject)=>{
        const s=document.createElement("script");
        s.src=url;
        s.onload=()=>resolve(url);
        s.onerror=()=>reject(new Error("load failed: "+url));
        document.head.appendChild(s);
      });
    }
    async function ensureThree(){
      if(window.THREE) return "cached";
      const candidates = [
        "./libs/three.min.js", // âœ… ä½ çš„æœ¬åœ°
        "https://cdnjs.cloudflare.com/ajax/libs/three.js/r155/three.min.js",
        "https://unpkg.com/three@0.155.0/build/three.min.js"
      ];
      for(const u of candidates){
        try{
          await loadScript(u);
          if(window.THREE) return u;
        }catch(e){}
      }
      throw new Error("Three.js æœªåŠ è½½æˆåŠŸï¼šè¯·ç¡®è®¤ /libs/three.min.js æ–‡ä»¶åæ­£ç¡®");
    }

    // æ‰‹åŠ¿ï¼ˆå¯ç”¨å°±å¯ç”¨ï¼Œä¸å¯ç”¨å°±é™çº§ä¸ºæ‹–åŠ¨ï¼‰
    let hands=null, mpCamera=null, handReady=false;
    async function loadHands(){
      // å…ˆå°è¯• CDNï¼ˆä½ å¦‚æœä»¥åè¦å½»åº•ç¦»çº¿ï¼Œä¹Ÿå¯ä»¥æŠŠ mediapipe æ”¾åˆ° libs é‡Œå†æ”¹æˆ local-firstï¼‰
      const opts = [
        {hands:"https://unpkg.com/@mediapipe/hands/hands.js", cam:"https://unpkg.com/@mediapipe/camera_utils/camera_utils.js", base:"https://unpkg.com/@mediapipe/hands/"},
        {hands:"https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js", cam:"https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js", base:"https://cdn.jsdelivr.net/npm/@mediapipe/hands/"}
      ];
      for(const c of opts){
        try{
          await loadScript(c.cam);
          await loadScript(c.hands);
          if(window.Hands && window.Camera) return c.base;
        }catch(e){}
      }
      throw new Error("æ‰‹åŠ¿åº“åŠ è½½å¤±è´¥ï¼ˆç½‘ç»œå¯èƒ½æ‹¦æˆªå¤–é“¾ï¼‰");
    }

    // æ‰‹åŠ¿åˆ¤å®šï¼ˆæ›´æ¸…æ¥š + é˜²æŠ–ï¼‰
    const GEST={NONE:0,FIST:1,OPEN:2,PINCH:3,MOVE:4};
    function dist(a,b){
      const dx=a.x-b.x, dy=a.y-b.y, dz=(a.z||0)-(b.z||0);
      return Math.hypot(dx,dy,dz);
    }
    function isExt(lm, tip, pip){
      const w=lm[0];
      return dist(lm[tip],w) > dist(lm[pip],w)+0.02;
    }
    function classify(lm){
      const palm = dist(lm[0], lm[9]) + 1e-6;
      const pinch = dist(lm[4], lm[8]) < palm*0.28;
      const i=isExt(lm,8,6), m=isExt(lm,12,10), r=isExt(lm,16,14), p=isExt(lm,20,18);
      const open = i&&m&&r&&p&&!pinch;
      const fist = !i&&!m&&!r&&!p&&!pinch;
      if(pinch) return GEST.PINCH;
      if(open) return GEST.OPEN;
      if(fist) return GEST.FIST;
      return GEST.MOVE;
    }
    let stable=GEST.NONE, cnt=0;
    function stableGest(lm){
      const g=classify(lm);
      if(g===stable) cnt=Math.min(30,cnt+1);
      else { stable=g; cnt=1; }
      return cnt>=6 ? stable : GEST.NONE;
    }

    // Three åœºæ™¯ï¼ˆä¿æŒä½ ç°åœ¨â€œæš–é‡‘å†™å®â€çš„æ ‘é£æ ¼ï¼‰
    let THREE, renderer, scene, camera, root, treeGroup, ornaments, helixGroup, photosGroup, fogGroup, star;
    let raycaster, ndc;
    const STATE={COMPACT:0,SCATTER:1,PHOTO:2};
    let state=STATE.COMPACT, spread=0, targetSpread=0;

    let yaw=0, pitch=-0.08, yawVel=0, pitchVel=0, roll=0;
    let dragging=false, lastX=0, lastY=0;

    function clamp(v,a,b){return Math.max(a,Math.min(b,v))}
    function smoothstep(t){return t*t*(3-2*t)}

    function makeRadialTex(c0,c1){
      const cvs=document.createElement("canvas"); cvs.width=cvs.height=128;
      const g=cvs.getContext("2d");
      const rg=g.createRadialGradient(64,64,0,64,64,64);
      rg.addColorStop(0,c0); rg.addColorStop(1,c1);
      g.fillStyle=rg; g.fillRect(0,0,128,128);
      const tex=new THREE.CanvasTexture(cvs);
      tex.needsUpdate=true;
      return tex;
    }

    function setState(s){
      state=s;
      if(s===STATE.COMPACT) targetSpread=0;
      if(s===STATE.SCATTER) targetSpread=1;
      if(s===STATE.PHOTO) targetSpread=1;
    }

    function buildStar(){
      const shape=new THREE.Shape();
      const R=1.0, r=0.42;
      const pts=[];
      for(let i=0;i<10;i++){
        const ang=-Math.PI/2 + i*(Math.PI/5);
        const rad=(i%2===0)?R:r;
        pts.push(new THREE.Vector2(Math.cos(ang)*rad, Math.sin(ang)*rad));
      }
      shape.moveTo(pts[0].x, pts[0].y);
      for(let i=1;i<pts.length;i++) shape.lineTo(pts[i].x, pts[i].y);
      shape.closePath();
      const geo=new THREE.ExtrudeGeometry(shape,{depth:0.22, bevelEnabled:true, bevelThickness:0.08, bevelSize:0.06, bevelSegments:2});
      geo.center();
      const mat=new THREE.MeshStandardMaterial({color:0xffc54d, metalness:0.95, roughness:0.18, emissive:0x3b2200, emissiveIntensity:0.55});
      const m=new THREE.Mesh(geo,mat);
      m.scale.setScalar(0.55);
      return m;
    }

    function makeHelixCurve(height, radius, turns){
      const pts=[];
      const seg=240;
      for(let i=0;i<=seg;i++){
        const t=i/seg;
        const ang=t*turns*Math.PI*2;
        const y=(t-0.5)*height;
        const r=radius*(0.96 - 0.22*t);
        pts.push(new THREE.Vector3(Math.cos(ang)*r, y, Math.sin(ang)*r));
      }
      return new THREE.CatmullRomCurve3(pts);
    }

    function applyResponsive(){
      const w=innerWidth, h=innerHeight;
      const short=Math.min(w,h);
      const phone = short<520;
      camera.fov = phone ? 58 : 52;
      camera.aspect = w/h;
      camera.updateProjectionMatrix();
      renderer.setPixelRatio(Math.min(devicePixelRatio||1, phone?1.6:2));
      renderer.setSize(w,h);

      const scale = clamp(short/820, 0.78, 1.18);
      root.scale.setScalar(scale);
    }

    function buildScene(){
      const app=document.getElementById("app");
      app.innerHTML="";

      scene=new THREE.Scene();
      scene.fog=new THREE.FogExp2(0x07070a, 0.035);

      camera=new THREE.PerspectiveCamera(52, innerWidth/innerHeight, 0.05, 80);
      camera.position.set(0, 1.15, 5.2);

      renderer=new THREE.WebGLRenderer({antialias:true, alpha:false, powerPreference:"high-performance"});
      renderer.outputColorSpace = THREE.SRGBColorSpace;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.25; // æ›´äº®æ›´æš–
      app.appendChild(renderer.domElement);

      raycaster=new THREE.Raycaster();
      ndc=new THREE.Vector2();

      // å…‰
      scene.add(new THREE.AmbientLight(0xffe2bf, 0.62));
      const key=new THREE.DirectionalLight(0xfff0d2, 0.85); key.position.set(2.6,4.0,2.0); scene.add(key);
      const fill=new THREE.PointLight(0xffcc88, 1.2, 25, 2); fill.position.set(-2.5,2.0,3.0); scene.add(fill);
      const rim=new THREE.PointLight(0xffd36a, 0.9, 25, 2); rim.position.set(2.8,1.2,-3.2); scene.add(rim);

      root=new THREE.Group();
      scene.add(root);

      treeGroup=new THREE.Group();
      ornaments=new THREE.Group();
      helixGroup=new THREE.Group();
      photosGroup=new THREE.Group();
      fogGroup=new THREE.Group();
      root.add(treeGroup, helixGroup, ornaments, photosGroup, fogGroup);

      // åˆ†æç‚¹äº‘
      const pts=[];
      function addBranch(level, start, dir, len){
        const seg=18;
        for(let i=0;i<=seg;i++){
          const t=i/seg;
          const p=start.clone().add(dir.clone().multiplyScalar(len*t));
          const jitter=0.06 + 0.10*(1-t) + 0.04*level;
          p.x += (Math.random()-0.5)*jitter;
          p.y += (Math.random()-0.5)*jitter*0.45;
          p.z += (Math.random()-0.5)*jitter;
          pts.push(p);
        }
        if(level<=0) return;
        const childN=2 + (Math.random()<0.35 ? 1 : 0);
        for(let k=0;k<childN;k++){
          const nd=dir.clone();
          nd.x += (Math.random()-0.5)*0.9;
          nd.y += 0.75 + Math.random()*0.55;
          nd.z += (Math.random()-0.5)*0.9;
          nd.normalize();
          const nl=len*(0.55 + Math.random()*0.18);
          addBranch(level-1, start.clone().add(dir.clone().multiplyScalar(len*(0.55+Math.random()*0.25))), nd, nl);
        }
      }
      addBranch(3, new THREE.Vector3(0,-1.25,0), new THREE.Vector3(0,1,0), 2.6);

      const leafGeom=new THREE.BufferGeometry().setFromPoints(pts);
      const leafMat=new THREE.PointsMaterial({
        color:0x1c6f4a, size:0.035, transparent:true, opacity:0.82,
        depthWrite:false, blending:THREE.AdditiveBlending
      });
      treeGroup.add(new THREE.Points(leafGeom, leafMat));

      // å…‰é›¾
      const fogTex=makeRadialTex("rgba(255,220,170,.52)","rgba(10,12,14,0)");
      for(let i=0;i<170;i++){
        const sp=new THREE.Sprite(new THREE.SpriteMaterial({
          map:fogTex, color:(Math.random()<0.6)?0xffe0b8:0xa8ffd0,
          transparent:true, opacity:0.12+Math.random()*0.10,
          depthWrite:false, blending:THREE.AdditiveBlending
        }));
        const y=-1.15 + Math.random()*3.0;
        const r=(1.0 - (y+1.15)/3.0) * (0.95 + Math.random()*0.35);
        const a=Math.random()*Math.PI*2;
        sp.position.set(Math.cos(a)*r, y, Math.sin(a)*r);
        const s=0.55 + Math.random()*1.15;
        sp.scale.set(s,s,1);
        fogGroup.add(sp);
      }

      // é‡‘/çº¢çƒï¼ˆä»…äº®é‡‘+äº®çº¢ï¼‰
      const goldMat=new THREE.MeshStandardMaterial({color:0xffd36a, metalness:0.95, roughness:0.20, emissive:0x2b1a00, emissiveIntensity:0.35});
      const redMat =new THREE.MeshStandardMaterial({color:0xff2a2a, metalness:0.65, roughness:0.30, emissive:0x330000, emissiveIntensity:0.22});
      const ballGeo=new THREE.SphereGeometry(0.085, 18, 18);
      const balls=72;
      for(let i=0;i<balls;i++){
        const m=new THREE.Mesh(ballGeo, (Math.random()<0.55)?goldMat:redMat);
        const t=i/(balls-1);
        const y=-1.0 + t*2.55;
        const radius=(1.08 - t*0.95) * (0.95 + ((i%6)%2)*0.06);
        const ang=(i*0.61803398875*2*Math.PI) + ((i%6)*0.35);
        m.position.set(Math.cos(ang)*radius, y, Math.sin(ang)*radius);
        m.userData.compact=m.position.clone();
        m.userData.scatter=new THREE.Vector3((Math.random()-0.5)*5.2, (Math.random()-0.5)*3.4, (Math.random()-0.5)*5.2);
        ornaments.add(m);
      }

      // æ˜Ÿæ˜Ÿï¼ˆæ›´æ˜æ˜¾ï¼‰
      star=buildStar();
      star.position.set(0, 1.62, 0);
      star.userData.compact=star.position.clone();
      star.userData.scatter=new THREE.Vector3(0.2, 1.2, -0.6);
      root.add(star);

      // æ ‡å‡†èºæ—‹é‡‘çº¿ï¼ˆåˆæ‹¢æ€æ›´â€œæ ‡å‡†â€ï¼‰
      const helix = makeHelixCurve(3.1, 1.12, 7.6);
      const tubeGeo=new THREE.TubeGeometry(helix, 340, 0.015, 10, false);
      const tubeMat=new THREE.MeshBasicMaterial({color:0xffea74, transparent:true, opacity:0.62});
      const tube=new THREE.Mesh(tubeGeo, tubeMat);
      helixGroup.add(tube);

      const glowTex=makeRadialTex("rgba(255,240,190,.95)","rgba(0,0,0,0)");
      const bulbs=160;
      for(let i=0;i<bulbs;i++){
        const tt=i/(bulbs-1);
        const p=helix.getPointAt(tt);
        const bulb=new THREE.Mesh(new THREE.SphereGeometry(0.018, 10, 10),
          new THREE.MeshBasicMaterial({color:0xfff2b0, transparent:true, opacity:0.95})
        );
        bulb.position.copy(p);
        helixGroup.add(bulb);

        const glow=new THREE.Sprite(new THREE.SpriteMaterial({
          map:glowTex, color:0xffd36a, transparent:true, opacity:0.55,
          depthWrite:false, blending:THREE.AdditiveBlending
        }));
        glow.position.copy(p);
        glow.scale.set(0.22,0.22,1);
        helixGroup.add(glow);
      }

      // ç…§ç‰‡ï¼š7 å¼ å¹³é¢ï¼ˆä¸Šä¼ åè´´å›¾ï¼‰
      const planeGeo=new THREE.PlaneGeometry(0.62, 0.42);
      for(let i=0;i<MAX_PHOTOS;i++){
        const mat=new THREE.MeshBasicMaterial({color:0xffffff, transparent:true, opacity:0.28, side:THREE.DoubleSide});
        const plane=new THREE.Mesh(planeGeo, mat);
        plane.userData.index=i;
        initPhotoSlot(plane, i);
        photosGroup.add(plane);
        photoPlanes.push(plane);
      }

      // åœ°é¢æŸ”å…‰
      const floorTex=makeRadialTex("rgba(255,210,120,.14)","rgba(0,0,0,0)");
      const floor=new THREE.Mesh(new THREE.PlaneGeometry(40,40),
        new THREE.MeshBasicMaterial({map:floorTex, transparent:true, opacity:0.55, depthWrite:false})
      );
      floor.rotation.x=-Math.PI/2; floor.position.y=-1.45;
      scene.add(floor);

      // äº¤äº’ï¼šæ‹–åŠ¨æ—‹è½¬
      const c=renderer.domElement;
      c.addEventListener("pointerdown",(e)=>{dragging=true; lastX=e.clientX; lastY=e.clientY;},{passive:true});
      window.addEventListener("pointerup",()=>dragging=false,{passive:true});
      window.addEventListener("pointermove",(e)=>{
        if(!dragging) return;
        const dx=(e.clientX-lastX); const dy=(e.clientY-lastY);
        lastX=e.clientX; lastY=e.clientY;
        yawVel += dx*0.010;
        pitchVel += dy*0.008;
      },{passive:true});

      applyResponsive();
      window.addEventListener("resize", applyResponsive, {passive:true});
    }

    function initPhotoSlot(plane, i){
      // åˆ†å±‚ + å‘¨å‘å‡åŒ€
      const layers=[
        {y:-0.70, n:3, r:1.05},
        {y: 0.10, n:2, r:0.78},
        {y: 0.86, n:2, r:0.56},
      ];
      let acc=0, li=0, slot=0;
      for(let k=0;k<layers.length;k++){
        const n=layers[k].n;
        if(i<acc+n){ li=k; slot=i-acc; break; }
        acc+=n;
      }
      const L=layers[li];
      const ang=slot*(Math.PI*2/L.n) + li*0.35;
      const pos=new THREE.Vector3(Math.cos(ang)*L.r, L.y, Math.sin(ang)*L.r);
      plane.position.copy(pos);
      plane.userData.compact=pos.clone();
      plane.userData.scatter=new THREE.Vector3((Math.random()-0.5)*5.2, (Math.random()-0.5)*3.4+0.3, (Math.random()-0.5)*5.2);
    }

    function showPhoto(url){
      document.body.classList.add("photo-mode");
      $("photoImg").src=url;
      $("photoStage").style.display="flex";
    }
    function hidePhoto(){
      document.body.classList.remove("photo-mode");
      $("photoStage").style.display="none";
      $("photoImg").src="";
    }

    function pickPhotoByNDC(nx, ny){
      ndc.set(nx*2-1, -(ny*2-1));
      raycaster.setFromCamera(ndc, camera);
      const hits=raycaster.intersectObjects(photoPlanes, false);
      if(hits && hits.length) return hits[0].object;
      return null;
    }

    function animate(now){
      const dt=Math.min(0.033, (animate._prev? (now-animate._prev)/1000 : 0.016));
      animate._prev=now;

      // çŠ¶æ€è¿‡æ¸¡
      spread += (targetSpread - spread) * (1 - Math.pow(0.0001, dt));
      spread=clamp(spread,0,1);
      const a=smoothstep(spread);

      // èºæ—‹çº¿ï¼šæ•£å¼€æ€â€œæ¼‚â€ï¼Œåˆæ‹¢æ€â€œæ ‡å‡†â€
      helixGroup.position.x = 0.18*Math.sin(now*0.0009)*spread;
      helixGroup.position.z = 0.14*Math.cos(now*0.0011)*spread;
      helixGroup.rotation.y = 0.18*Math.sin(now*0.0012)*spread;

      // çƒæ¼‚æµ®
      ornaments.children.forEach((m, idx)=>{
        const p=m.userData.compact.clone().lerp(m.userData.scatter, a);
        p.y += spread*(0.10*Math.sin(now*0.001 + idx*0.7));
        m.position.copy(p);
      });

      // æ˜Ÿ
      if(star){
        const p=star.userData.compact.clone().lerp(star.userData.scatter, a);
        p.y += spread*(0.10*Math.sin(now*0.0012));
        star.position.copy(p);
        star.rotation.y += 0.01;
      }

      // å…‰é›¾
      fogGroup.children.forEach((sp,i)=>{
        sp.position.x += 0.0025*Math.sin(now*0.0012 + i)*spread;
        sp.position.z += 0.0020*Math.cos(now*0.0011 + i*1.2)*spread;
      });

      // ç…§ç‰‡ï¼šæ’å€¼ + æ­£å¯¹é•œå¤´ï¼›è¢«é€‰ä¸­çš„åšç£å¸å¼¹æ€§
      photoPlanes.forEach((p,i)=>{
        const target=p.userData.compact.clone().lerp(p.userData.scatter, a);
        target.x += spread*(0.08*Math.sin(now*0.0015 + i*2.1));
        target.y += spread*(0.06*Math.cos(now*0.0013 + i*1.8));
        target.z += spread*(0.08*Math.cos(now*0.0014 + i*1.6));

        const k=1 - Math.pow(0.00001, dt);

        if(selectedPlane && p===selectedPlane){
          const center=camera.position.clone().add(camera.getWorldDirection(new THREE.Vector3()).multiplyScalar(2.2));
          p.position.lerp(center, k);
          const s=1 + 1.35*(pinchHolding?1:0);
          p.scale.lerp(new THREE.Vector3(s,s,s), k);
        }else{
          p.position.lerp(target, k);
          p.scale.lerp(new THREE.Vector3(1,1,1), k);
        }

        p.lookAt(camera.position);
      });

      // ç›¸æœºè·Ÿéšï¼ˆæ‹–åŠ¨/æ‰‹åŠ¿å…±ç”¨é€Ÿåº¦ï¼‰
      yawVel *= (1 - 0.22*(1 - Math.pow(0.0008, dt)));
      pitchVel *= (1 - 0.22*(1 - Math.pow(0.0008, dt)));
      yaw += yawVel*dt;
      pitch += pitchVel*dt;
      pitch=clamp(pitch,-0.65,0.55);

      const radius = 5.2 - 1.15*spread;
      camera.position.set(Math.sin(yaw)*radius, 1.15 + pitch*2.0, Math.cos(yaw)*radius);
      camera.lookAt(0, 0.35, 0);
      camera.rotation.z = roll;

      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    }

    async function startHands(){
      try{
        const base=await loadHands();
        const video=$("video");

        hands = new Hands({ locateFile:(f)=>base+f });
        hands.setOptions({ maxNumHands:1, modelComplexity:1, minDetectionConfidence:0.60, minTrackingConfidence:0.60 });
        hands.onResults((res)=>{
          if(!res || !res.multiHandLandmarks || !res.multiHandLandmarks[0]) return;
          const lm=res.multiHandLandmarks[0];
          const g=stableGest(lm);

          // ç”¨æŒå¿ƒä½ç½®ä½œä¸ºæ§åˆ¶
          const palmX=(lm[0].x + lm[5].x + lm[17].x)/3;
          const palmY=(lm[0].y + lm[9].y + lm[13].y)/3;

          // roll è½»å¾®åŠ æˆ
          const a=lm[5], b=lm[17];
          const ang=Math.atan2((b.y-a.y),(b.x-a.x));
          roll=clamp(ang*0.18, -0.15, 0.15);

          if(g===GEST.FIST){
            setState(STATE.COMPACT);
            selectedPlane=null; pinchHolding=false; hidePhoto();
          }else if(g===GEST.OPEN){
            if(state!==STATE.PHOTO) setState(STATE.SCATTER);
          }

          if(state===STATE.SCATTER && g!==GEST.PINCH){
            // æ›´è·Ÿæ‰‹ï¼šç§¯åˆ†å¼é€Ÿåº¦
            if(startHands._lastX!=null){
              const dx=palmX-startHands._lastX;
              const dy=palmY-startHands._lastY;
              yawVel   += dx*6.2;
              pitchVel += dy*4.6;
            }
          }

          if(g===GEST.PINCH){
            if(!pinchHolding){
              pinchHolding=true;
              const picked=pickPhotoByNDC(palmX, palmY);
              if(picked){
                selectedPlane=picked;
                setState(STATE.PHOTO);
                const idx=picked.userData.index;
                const url=photoUrls[idx];
                if(url) showPhoto(url);
                else toast("è¿™å¼ ç…§ç‰‡è¿˜æ²¡ä¸Šä¼ ï¼šè¯·å…ˆç‚¹â€œä¸Šä¼ ç…§ç‰‡(â‰¤7)â€é€‰æ‹©å›¾ç‰‡", 2800);
              }
            }
          }else{
            if(pinchHolding){
              pinchHolding=false;
              selectedPlane=null;
              hidePhoto();
              setState(STATE.SCATTER);
            }
          }

          startHands._lastX=palmX; startHands._lastY=palmY;
        });

        mpCamera = new Camera(video, {
          onFrame: async ()=>{ await hands.send({image: video}); },
          width:  640,
          height: 480
        });
        await mpCamera.start();

        handReady=true;
        setDot("dotHand","on"); $("txtHand").textContent="å·²å¯ç”¨";
        return true;
      }catch(e){
        handReady=false;
        setDot("dotHand","warn"); $("txtHand").textContent="æœªå¯ç”¨";
        toast("æ‰‹åŠ¿åº“åŠ è½½å¤±è´¥ï¼šä»å¯ç”¨æ‰‹æŒ‡/é¼ æ ‡æ‹–åŠ¨æ—‹è½¬ï¼ˆå»ºè®®æ¢ç³»ç»Ÿæµè§ˆå™¨/æ¢ç½‘ç»œï¼‰", 4200);
        return false;
      }
    }

    // ä¸Šä¼ ç…§ç‰‡ï¼šæŒ‰é’®è§¦å‘ input.click()ï¼ˆè§£å†³ä½ â€œé€‰äº†ä¹Ÿæ˜¾ç¤ºæœªé€‰æ‹©â€ï¼‰
    const thumbs=$("thumbs");
    function clearThumbs(){ thumbs.innerHTML=""; }
    function addThumb(url){
      const d=document.createElement("div");
      d.className="thumb";
      const img=document.createElement("img");
      img.src=url;
      d.appendChild(img);
      thumbs.appendChild(d);
    }
    function applyPhotoTexture(i, url){
      const loader=new THREE.TextureLoader();
      loader.load(url, (tex)=>{
        tex.colorSpace = THREE.SRGBColorSpace;
        tex.anisotropy = Math.min(8, renderer.capabilities.getMaxAnisotropy());
        photoPlanes[i].material.map = tex;
        photoPlanes[i].material.opacity = 0.98;
        photoPlanes[i].material.needsUpdate = true;
      }, undefined, ()=>{
        // ignore
      });
    }

    $("btnPick").addEventListener("click", ()=> $("fileInput").click());
    $("fileInput").addEventListener("change", ()=>{
      const files=$("fileInput").files;
      if(!files || !files.length){
        $("fileHint").textContent="æœªé€‰æ‹©æ–‡ä»¶";
        return;
      }
      const list=Array.from(files).slice(0, MAX_PHOTOS);
      $("fileHint").textContent=`å·²é€‰æ‹© ${list.length} å¼ `;
      clearThumbs();

      while(photoUrls.length) URL.revokeObjectURL(photoUrls.pop());
      list.forEach((f, idx)=>{
        const url=URL.createObjectURL(f);
        photoUrls.push(url);
        addThumb(url);
        applyPhotoTexture(idx, url);
      });
      for(let i=list.length;i<MAX_PHOTOS;i++){
        photoPlanes[i].material.map=null;
        photoPlanes[i].material.opacity=0.28;
        photoPlanes[i].material.needsUpdate=true;
      }
    });

    // é¢æ¿æŒ‰é’®å¤‡ç”¨
    $("btnCompact").addEventListener("click", ()=>{ setState(STATE.COMPACT); selectedPlane=null; pinchHolding=false; hidePhoto(); });
    $("btnScatter").addEventListener("click", ()=>{ setState(STATE.SCATTER); selectedPlane=null; pinchHolding=false; hidePhoto(); });
    $("btnReplay").addEventListener("click", ()=>playBGM());
    $("btnRecam").addEventListener("click", async ()=>{ await openCamera(); if(!handReady) startHands(); });

    // å¯åŠ¨æŒ‰é’®ï¼šçœŸæ­£çš„å¯åŠ¨å‡½æ•°ï¼ˆè¦†ç›–æ‰æœ€å¼€å§‹çš„å ä½ alertï¼‰
    window.__startExperience = async function(){
      try{
        $("startStatus").textContent="æ­£åœ¨åŠ è½½ Three.jsâ€¦";
        const src=await ensureThree();
        THREE=window.THREE;
        setDot("dotThree","on"); $("txtThree").textContent="å·²åŠ è½½";
        $("startStatus").textContent="æ­£åœ¨åˆå§‹åŒ–åœºæ™¯â€¦";
        buildScene();
        requestAnimationFrame(animate);

        $("startStatus").textContent="æ­£åœ¨æ’­æ”¾éŸ³ä¹ & è¯·æ±‚æ‘„åƒå¤´æƒé™â€¦";
        await Promise.all([playBGM(), openCamera()]);

        // æ‰‹åŠ¿ï¼ˆå¯å¤±è´¥ä½†ä¸å½±å“æ‹–åŠ¨äº¤äº’ï¼‰
        $("startStatus").textContent="æ­£åœ¨å¯åŠ¨æ‰‹åŠ¿è¯†åˆ«â€¦";
        await startHands();

        // åˆå§‹åˆæ‹¢æ€
        setState(STATE.COMPACT);

        // æ”¶èµ· overlay
        document.getElementById("startOverlay").style.display="none";
        toast("å·²è¿›å…¥ä½“éªŒ âœ…", 1400);
      }catch(e){
        setDot("dotThree","warn"); $("txtThree").textContent="å¤±è´¥";
        $("startStatus").textContent="å¯åŠ¨å¤±è´¥ï¼š\n"+(e && e.message ? e.message : String(e));
        toast("å¯åŠ¨å¤±è´¥ï¼šè¯·ç¡®è®¤ libs/three.min.js å­˜åœ¨ï¼ˆæ–‡ä»¶åå¿…é¡»æ˜¯ three.min.jsï¼‰", 5200);
      }
    };

    // é¡µé¢å°æç¤ºï¼šThree æ˜¯å¦å·²å­˜åœ¨
    if(window.THREE){
      setDot("dotThree","on"); $("txtThree").textContent="å·²åŠ è½½";
    }else{
      setDot("dotThree","warn"); $("txtThree").textContent="å¾…åŠ è½½";
    }
    setDot("dotHand","warn"); $("txtHand").textContent="å¾…å¯åŠ¨";
  })();
  </script>
</body>
</html>
