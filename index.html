<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ç²’å­åœ£è¯æ ‘ Â· æ‰‹åŠ¿äº¤äº’</title>
  <style>
    :root{
      --bg0:#07060a; --bg1:#151018;
      --gold:#ffd36a; --gold2:#ffefb0;
      --red:#ff2a2a; --green:#1f6b3a;
    }
    html,body{
      margin:0;height:100%;
      background:radial-gradient(1200px 800px at 50% 35%, #211326 0%, var(--bg1) 35%, var(--bg0) 100%);
      overflow:hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC","Microsoft YaHei", Arial;
    }
    #wrap{position:fixed; inset:0;}
    canvas{display:block; width:100%; height:100%; touch-action:none;}

    #ui{
      position:fixed; left:14px; top:14px; z-index:20;
      display:flex; flex-direction:column; gap:10px;
      min-width:min(360px, calc(100vw - 28px));
      pointer-events:auto;
    }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 12px 32px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      border-radius:14px;
      padding:10px 12px;
      color:rgba(255,255,255,.92);
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .btn{
      cursor:pointer; user-select:none;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color:rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius:12px;
      font-weight:800;
      letter-spacing:.2px;
      display:inline-flex; align-items:center; gap:8px;
      transition: transform .12s ease, background .18s ease, border-color .18s ease;
    }
    .btn:active{transform: scale(.98);}
    .btn.on{background: rgba(255,211,106,.12); border-color: rgba(255,211,106,.35);}
    .hint{font-size:12px; line-height:1.35; color:rgba(255,255,255,.80);}
    .hint b{color:rgba(255,243,205,.95)}
    .file{
      display:inline-flex; align-items:center; gap:10px;
      padding:8px 10px; border-radius:12px;
      border:1px dashed rgba(255,255,255,.22);
      background: rgba(0,0,0,.18);
    }
    input[type="file"]{max-width:220px; color:rgba(255,255,255,.88)}

    #startOverlay{
      position:fixed; inset:0; z-index:50;
      display:grid; place-items:center;
      background:
        radial-gradient(900px 700px at 50% 45%, rgba(255,211,106,.10) 0%, rgba(255,42,42,.06) 25%, rgba(0,0,0,.70) 70%),
        linear-gradient(180deg, rgba(10,7,14,.92), rgba(0,0,0,.94));
      transition: opacity .35s ease, visibility .35s ease;
    }
    #startOverlay.hide{opacity:0; visibility:hidden; pointer-events:none;}
    .startCard{
      width:min(560px, calc(100vw - 44px));
      border-radius:22px;
      padding:22px 18px 18px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
      text-align:center;
      color:rgba(255,255,255,.93);
    }
    .startTitle{font-size:22px; font-weight:950; letter-spacing:.6px; margin:0 0 10px;}
    .startSub{margin:0 0 16px; font-size:13px; color:rgba(255,255,255,.78); line-height:1.5;}
    #startBtn{
      width:100%;
      border:none;
      cursor:pointer;
      padding:16px 18px;
      border-radius:18px;
      font-size:18px;
      font-weight:950;
      letter-spacing:.8px;
      color:#1b0f08;
      background: linear-gradient(90deg, #ffe08a, #ffd36a, #ffefb0);
      box-shadow: 0 12px 30px rgba(255,211,106,.22), inset 0 1px 0 rgba(255,255,255,.65);
      transition: transform .12s ease, filter .2s ease, opacity .2s ease;
    }
    #startBtn:active{transform: scale(.985);}
    #startBtn[disabled]{opacity:.75; cursor:not-allowed;}
    #startStatus{
      margin-top:10px;
      font-size:12px;
      color:rgba(255,255,255,.80);
      line-height:1.45;
      min-height:22px;
      white-space:pre-line;
    }

    #toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      z-index:60; pointer-events:none;
      background: rgba(0,0,0,.56);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(10px);
      color:rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      max-width:min(560px, calc(100vw - 28px));
      opacity:0; transition: opacity .25s ease;
    }
    #toast.show{opacity:1;}

    #photoOverlay{
      position:fixed; inset:0; z-index:40;
      display:none; place-items:center;
      pointer-events:none;
    }
    #photoOverlay.show{display:grid;}
    #photoCard{
      width:min(86vw, 720px);
      height:min(68vh, 520px);
      border-radius:18px;
      overflow:hidden;
      box-shadow: 0 22px 60px rgba(0,0,0,.62);
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.22);
      transform: scale(.90);
      opacity:0;
      transition: transform .22s cubic-bezier(.2,.9,.25,1.1), opacity .18s ease;
    }
    #photoOverlay.show #photoCard{transform: scale(1); opacity:1;}
    #photoImg{width:100%; height:100%; object-fit:contain; background: rgba(0,0,0,.35);}
    body.photo-mode canvas{filter: blur(8px) brightness(1.08) saturate(1.08); transition: filter .18s ease;}
    body:not(.photo-mode) canvas{filter:none; transition: filter .18s ease;}
  </style>
</head>

<body>
  <div id="wrap"></div>

  <div id="ui">
    <div class="panel">
      <div class="row">
        <div id="camBtn" class="btn"><span>ğŸ“·</span><span>æ‘„åƒå¤´ï¼šå…³é—­</span></div>
        <div id="musicBtn" class="btn"><span>ğŸµ</span><span>éŸ³ä¹ï¼šå…³é—­</span></div>
        <div class="file">
          <span>ğŸ–¼ï¸ ä¸Šä¼ ç…§ç‰‡(â‰¤7)</span>
          <input id="fileInput" type="file" accept="image/*" multiple />
        </div>
      </div>
      <div class="hint" style="margin-top:8px">
        ç›®å‰è¿™ä¸ªç‰ˆæœ¬ï¼šæ‹–åŠ¨å±å¹•å¯æ—‹è½¬è§†è§’ï¼›ç‚¹å‡»æŒ‰é’®ä¼šå°è¯•æ’­æ”¾éŸ³ä¹ + è¯·æ±‚æ‘„åƒå¤´æƒé™ã€‚<br/>
        ï¼ˆä½ ä¹‹å‰çš„æ‰‹åŠ¿è¯†åˆ«åŠŸèƒ½ï¼Œæˆ‘ä»¬ç­‰ç¨³å®šæ˜¾ç¤ºåå†æŠŠ MediaPipe åšæˆæœ¬åœ° libs å…œåº•ã€‚ï¼‰
      </div>
    </div>
  </div>

  <div id="startOverlay">
    <div class="startCard">
      <h2 class="startTitle">âœ¨ åœ£è¯æ ‘ Â· å¼€å§‹ä½“éªŒ</h2>
      <p class="startSub">ç‚¹ä¸€æ¬¡å°±ä¼šå°è¯•æ’­æ”¾åœ£è¯BGMï¼Œå¹¶è¯·æ±‚æ‘„åƒå¤´æƒé™ã€‚<br/>ï¼ˆå°±ç®—æ‘„åƒå¤´æ²¡å¼€æˆåŠŸï¼Œä¹Ÿä¼šè¿›å…¥ä½“éªŒï¼‰</p>
      <button id="startBtn">å¼€å§‹ä½“éªŒï¼ˆç‚¹æˆ‘ï¼‰</button>
      <div id="startStatus"></div>
    </div>
  </div>

  <div id="toast"></div>

  <div id="photoOverlay">
    <div id="photoCard"><img id="photoImg" alt="photo" /></div>
  </div>

  <audio id="bgm" preload="auto" loop playsinline
    src="https://upload.wikimedia.org/wikipedia/commons/3/32/Carol_of_the_Bells_-_Concert_Band_-_United_States_Air_Force_Band_of_the_Rockies.mp3"></audio>

  <!-- âœ… æœ¬åœ°åŠ è½½ Three -->
  <script src="./libs/three.min.js"></script>

  <script>
    (function(){
      const toastEl = document.getElementById("toast");
      let toastTimer=null;
      function toast(msg, ms=2600){
        toastEl.textContent=msg;
        toastEl.classList.add("show");
        clearTimeout(toastTimer);
        toastTimer=setTimeout(()=>toastEl.classList.remove("show"), ms);
      }

      const startBtn=document.getElementById("startBtn");
      const startStatus=document.getElementById("startStatus");
      const startOverlay=document.getElementById("startOverlay");
      const camBtn=document.getElementById("camBtn");
      const musicBtn=document.getElementById("musicBtn");
      const fileInput=document.getElementById("fileInput");
      const bgm=document.getElementById("bgm");

      function setStatus(s){ startStatus.textContent=s; }

      window.addEventListener("error",(e)=>toast("è„šæœ¬é”™è¯¯ï¼š" + (e?.message||"æœªçŸ¥é”™è¯¯"),5200));
      window.addEventListener("unhandledrejection",(e)=>toast("è„šæœ¬å¼‚å¸¸ï¼š" + (e?.reason?.message||e?.reason||"æœªçŸ¥åŸå› "),5200));

      if(!window.THREE){
        setStatus("æœªæ£€æµ‹åˆ° THREEï¼š\nè¯·ç¡®è®¤ libs/three.min.js æ–‡ä»¶åæ­£ç¡®ã€‚\nç„¶åç”¨ ?v=3 å¼ºåˆ¶åˆ·æ–°ã€‚");
        toast("THREE æœªåŠ è½½ï¼šè¯·å¼ºåˆ¶åˆ·æ–°ï¼ˆæ— ç—•æ¨¡å¼ä¹Ÿè¡Œï¼‰", 6000);
        return;
      }
      const THREE = window.THREE;

      // âœ… ä¿®å¤å…³é”®ï¼šæ‰€æœ‰ç”¨äº pow çš„ t å¿…é¡»å¤¹åœ¨ 0~1
      const clamp01 = (v)=> Math.max(0, Math.min(1, v));

      // ---- éŸ³ä¹æ·¡å…¥æ·¡å‡º ----
      let musicOn=false, fadeRAF=0;
      function setMusic(on){
        musicOn=on;
        cancelAnimationFrame(fadeRAF);
        const target=on?0.85:0.0;
        const start=(typeof bgm.volume==="number")?bgm.volume:0;
        const t0=performance.now(), dur=520;
        const step=(t)=>{
          const p=Math.min(1,(t-t0)/dur);
          const s=p*p*(3-2*p);
          bgm.volume=start+(target-start)*s;
          if(p<1) fadeRAF=requestAnimationFrame(step);
        };
        fadeRAF=requestAnimationFrame(step);
        if(on){
          bgm.muted=false;
          bgm.play().catch(()=>toast("éŸ³ä¹æœªèƒ½è‡ªåŠ¨æ’­æ”¾ï¼šè¯·å†ç‚¹ä¸€ä¸‹é¡µé¢æˆ–ç‚¹â€œéŸ³ä¹ï¼šå¼€å¯â€",3500));
        }else{
          setTimeout(()=>{ try{bgm.pause();}catch{} },620);
        }
      }
      function updateMusicUI(){
        if(musicOn){
          musicBtn.classList.add("on");
          musicBtn.innerHTML="<span>ğŸµ</span><span>éŸ³ä¹ï¼šå¼€å¯</span>";
        }else{
          musicBtn.classList.remove("on");
          musicBtn.innerHTML="<span>ğŸµ</span><span>éŸ³ä¹ï¼šå…³é—­</span>";
        }
      }

      // ---- æ‘„åƒå¤´æƒé™å¼€å…³ï¼ˆæœ¬ç‰ˆä¸åšæ‰‹åŠ¿è®¡ç®—ï¼Œåªå…ˆä¿è¯æŒ‰é’®å·¥ä½œï¼‰----
      let camOn=false, stream=null, videoEl=null;
      function updateCamUI(){
        if(camOn){
          camBtn.classList.add("on");
          camBtn.innerHTML="<span>ğŸ“·</span><span>æ‘„åƒå¤´ï¼šå¼€å¯</span>";
        }else{
          camBtn.classList.remove("on");
          camBtn.innerHTML="<span>ğŸ“·</span><span>æ‘„åƒå¤´ï¼šå…³é—­</span>";
        }
      }
      async function startCamera(){
        if(camOn) return true;
        try{
          if(!navigator.mediaDevices?.getUserMedia){
            toast("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´ï¼šè¯·ç”¨ Safari/Chrome",4500);
            return false;
          }
          if(!videoEl){
            videoEl=document.createElement("video");
            videoEl.setAttribute("playsinline","");
            videoEl.muted=true; videoEl.autoplay=true;
            videoEl.style.position="fixed";
            videoEl.style.left="-9999px";
            videoEl.style.top="-9999px";
            document.body.appendChild(videoEl);
          }
          stream = await navigator.mediaDevices.getUserMedia({
            video:{ facingMode:"user", width:{ideal:960}, height:{ideal:540} },
            audio:false
          });
          videoEl.srcObject=stream;
          await videoEl.play();
          camOn=true; updateCamUI();
          toast("æ‘„åƒå¤´å·²å¼€å¯ âœ…",1500);
          return true;
        }catch(e){
          camOn=false; updateCamUI();
          toast("æ‘„åƒå¤´å¼€å¯å¤±è´¥ï¼šè¯·å…è®¸æƒé™ï¼›å°½é‡åˆ«åœ¨å¾®ä¿¡å†…æ‰“å¼€",4500);
          return false;
        }
      }
      function stopCamera(){
        if(!camOn) return;
        try{ stream?.getTracks?.().forEach(t=>t.stop()); }catch{}
        stream=null; camOn=false; updateCamUI();
        toast("å·²å…³é—­æ‘„åƒå¤´",1200);
      }

      camBtn.addEventListener("click", async ()=>{ camOn?stopCamera():await startCamera(); });
      musicBtn.addEventListener("click", ()=>{ setMusic(!musicOn); updateMusicUI(); });

      // ---- Three åœºæ™¯ ----
      const wrap=document.getElementById("wrap");

      let renderer, scene, camera, rig, tree, star;
      try{
        renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true, powerPreference:"high-performance" });
      }catch(e){
        setStatus("WebGL åˆå§‹åŒ–å¤±è´¥ï¼š\nä½ çš„æµè§ˆå™¨å¯èƒ½ç¦ç”¨äº† WebGLã€‚\nè¯·ç”¨ Safari/Chrome æ‰“å¼€ã€‚");
        toast("WebGL åˆå§‹åŒ–å¤±è´¥", 6000);
        return;
      }

      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.outputColorSpace = THREE.SRGBColorSpace;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.18;
      wrap.innerHTML="";
      wrap.appendChild(renderer.domElement);

      scene = new THREE.Scene();
      scene.fog = new THREE.FogExp2(0x07060a, 0.038);

      camera = new THREE.PerspectiveCamera(48, window.innerWidth/window.innerHeight, 0.08, 80);
      camera.position.set(0, 2.5, 8.2);

      rig = new THREE.Group();
      scene.add(rig);

      function applyResponsive(){
        const w=window.innerWidth, h=window.innerHeight;
        const aspect=w/h;
        const short=Math.min(w,h);
        const scale=THREE.MathUtils.clamp(short/820,0.78,1.18);
        rig.scale.setScalar(scale);

        const isPhone = short < 520 || aspect < 0.75;
        camera.fov = isPhone ? 56 : 48;
        camera.position.z = isPhone ? 9.4 : 8.2;
        camera.position.y = isPhone ? 2.75 : 2.5;
        camera.updateProjectionMatrix();
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, isPhone ? 1.75 : 2));
      }

      // æš–è‰²â€œç”µå½±æ„Ÿâ€
      scene.add(new THREE.AmbientLight(0xffe6b8, 0.58));
      const key=new THREE.DirectionalLight(0xfff0d6, 1.05); key.position.set(4,6,4); scene.add(key);
      const rim=new THREE.DirectionalLight(0xffd36a, 0.55); rim.position.set(-5,4,-4); scene.add(rim);
      const glow=new THREE.PointLight(0xffd36a, 1.0, 16, 2.0); glow.position.set(0,3.2,2.6); scene.add(glow);

      tree=new THREE.Group(); rig.add(tree);

      const TREE_H=5.2, BASE_R=2.0;

      // åˆ†æå±‚çº§ï¼ˆçº¿ï¼‰
      const branchGeom=new THREE.BufferGeometry();
      const segs=[];
      let seed=1.234;
      const randn=(s)=>{ const x=Math.sin(s)*10000; return x-Math.floor(x); };
      const levels=14, perLevel=46;
      for(let li=0; li<levels; li++){
        const y=(li/(levels-1))*(TREE_H*0.92);
        const t=clamp01(1 - y/(TREE_H*0.92));
        const r=BASE_R*Math.pow(t,0.55);
        for(let i=0;i<perLevel;i++){
          seed+=0.37;
          const a=(i/perLevel)*Math.PI*2 + randn(seed)*0.12;
          const len=0.25 + randn(seed+2.1)*0.45;
          const sx=Math.cos(a)*r*0.82;
          const sz=Math.sin(a)*r*0.82;
          const ex=Math.cos(a)*(r + len);
          const ez=Math.sin(a)*(r + len);
          const ey=y + (0.04 + randn(seed+4.2)*0.12);
          segs.push(sx,y,sz, ex,ey,ez);
        }
      }
      branchGeom.setAttribute("position", new THREE.Float32BufferAttribute(segs,3));
      const branchMat=new THREE.LineBasicMaterial({ color:0x1f6b3a, transparent:true, opacity:0.70 });
      tree.add(new THREE.LineSegments(branchGeom, branchMat));

      // é¡¶éƒ¨äº”è§’æ˜Ÿ
      function makeStar(){
        const shape=new THREE.Shape();
        const spikes=5, outer=0.34, inner=0.14;
        let rot=Math.PI/2*3, cx=0, cy=0;
        shape.moveTo(cx, cy-outer);
        for(let i=0;i<spikes;i++){
          shape.lineTo(cx+Math.cos(rot)*outer, cy+Math.sin(rot)*outer); rot+=Math.PI/spikes;
          shape.lineTo(cx+Math.cos(rot)*inner, cy+Math.sin(rot)*inner); rot+=Math.PI/spikes;
        }
        shape.closePath();
        const geo=new THREE.ExtrudeGeometry(shape,{depth:0.08, bevelEnabled:true, bevelThickness:0.02, bevelSize:0.02, bevelSegments:2});
        geo.center();
        const mat=new THREE.MeshStandardMaterial({
          color:0xffd36a, metalness:0.95, roughness:0.18,
          emissive:new THREE.Color(0xffb84a), emissiveIntensity:0.95
        });
        const m=new THREE.Mesh(geo,mat);
        m.position.set(0, TREE_H*0.98+0.25, 0);
        m.rotation.set(0.18, 0.0, 0.10);
        m.scale.setScalar(1.30);
        return m;
      }
      star=makeStar();
      tree.add(star);

      // âœ… ä¿®å¤åçš„èºæ—‹ç¯çº¿ï¼ˆt å¤¹ 0~1ï¼Œä¸ä¼š NaNï¼‰
      let helixMesh=null;
      const helixMat=new THREE.MeshBasicMaterial({ color:0xffd36a, transparent:true, opacity:0.88 });

      function buildHelixPoints(standardness, time){
        const pts=[];
        const turns=6.2, steps=220;
        for(let i=0;i<=steps;i++){
          const u=i/steps;
          const y=u*(TREE_H*0.92); // å»æ‰ 0.25 åç§»ï¼Œé¿å…è¶…è¿‡é¡¶éƒ¨äº§ç”Ÿè´Ÿ t
          const t=clamp01(1 - y/(TREE_H*0.92));
          const rBase=BASE_R*Math.pow(t,0.65)*0.98;

          const a0=u*turns*Math.PI*2;
          const wob=(1-standardness);
          const n1=Math.sin(time*0.9+u*12.0)*0.18*wob;
          const n2=Math.cos(time*0.7+u*9.0)*0.14*wob;

          const r=rBase*(1+n1);
          const a=a0+n2;

          const x=Math.cos(a)*r, z=Math.sin(a)*r;

          // é˜² NaN
          if(Number.isFinite(x) && Number.isFinite(y) && Number.isFinite(z)){
            pts.push(new THREE.Vector3(x, y+0.25, z)); // å†æŠŠæ•´ä½“æŠ¬é«˜ä¸€ç‚¹ç‚¹
          }
        }
        return pts;
      }

      function rebuildHelix(standardness, time){
        const pts = buildHelixPoints(standardness, time);
        if(pts.length < 10) return;

        if(helixMesh){
          tree.remove(helixMesh);
          try{ helixMesh.geometry.dispose(); }catch{}
        }
        const curve=new THREE.CatmullRomCurve3(pts);
        const geo=new THREE.TubeGeometry(curve, 220, 0.018, 10, false);
        helixMesh=new THREE.Mesh(geo, helixMat);
        helixMesh.renderOrder=1;
        tree.add(helixMesh);
      }
      rebuildHelix(1,0);

      // äº®é‡‘/äº®çº¢çƒ + é‡‘ç«‹æ–¹ä½“ï¼ˆç®€åŒ–ï¼‰
      const elements=[];
      const goldMat=new THREE.MeshStandardMaterial({ color:0xffd36a, metalness:0.95, roughness:0.18, emissive:new THREE.Color(0x2a1a06), emissiveIntensity:0.55 });
      const redMat =new THREE.MeshStandardMaterial({ color:0xff2a2a, metalness:0.60, roughness:0.25, emissive:new THREE.Color(0x200008), emissiveIntensity:0.35 });
      const sphereG=new THREE.SphereGeometry(0.09,22,18);
      const cubeG  =new THREE.BoxGeometry(0.11,0.11,0.11);

      seed=9.87;
      for(let i=0;i<170;i++){
        const m=(i%2===0)?goldMat:redMat;
        const mesh=new THREE.Mesh(sphereG,m);
        tree.add(mesh);
        elements.push({
          obj:mesh,
          compact:new THREE.Vector3(),
          scatter:new THREE.Vector3(),
          baseRot:new THREE.Euler(randn(seed+1)*0.6, randn(seed+2)*0.6, randn(seed+3)*0.6),
          wob:new THREE.Vector3(randn(seed+4), randn(seed+5), randn(seed+6))
        });
        seed+=0.41;
      }
      for(let i=0;i<48;i++){
        const mesh=new THREE.Mesh(cubeG,goldMat);
        tree.add(mesh);
        elements.push({
          obj:mesh,
          compact:new THREE.Vector3(),
          scatter:new THREE.Vector3(),
          baseRot:new THREE.Euler(randn(seed+1)*0.8, randn(seed+2)*0.8, randn(seed+3)*0.8),
          wob:new THREE.Vector3(randn(seed+4), randn(seed+5), randn(seed+6))
        });
        seed+=0.53;
      }

      function assignPositions(){
        for(const e of elements){
          seed+=0.37;
          const y=Math.pow(randn(seed+1.2),0.9)*(TREE_H*0.92);
          const t=clamp01(1 - y/(TREE_H*0.92));
          const r=BASE_R*Math.pow(t,0.75);
          const a=randn(seed+2.2)*Math.PI*2;
          e.compact.set(Math.cos(a)*r, y, Math.sin(a)*r);

          const sr=3.6+randn(seed+3.3)*2.2;
          const sa=randn(seed+4.4)*Math.PI*2;
          const sy=(randn(seed+5.5)-0.35)*3.1+1.1;
          e.scatter.set(Math.cos(sa)*sr, sy, Math.sin(sa)*sr);
        }
      }
      assignPositions();

      // ä¸Šä¼ ç…§ç‰‡ï¼ˆæœ¬ç‰ˆå…ˆä¸åšç…§ç‰‡èŠ‚ç‚¹ï¼Œé¿å…ä½ å†é‡åˆ°å´©æºƒï¼›ç­‰æ‰‹åŠ¿æœ¬åœ°åŒ–å†è¡¥å›ï¼‰
      fileInput.addEventListener("change", ()=>{
        toast("ç…§ç‰‡ä¸Šä¼ åŠŸèƒ½ä¸‹ä¸€æ­¥åŠ å›ï¼ˆå…ˆæŠŠæ˜¾ç¤º/æŒ‰é’®ç¨³å®šä½ï¼‰", 2600);
        fileInput.value="";
      });

      // ç›¸æœºæ—‹è½¬ï¼ˆæ‹–åŠ¨å±å¹•ï¼‰
      let yaw=0, pitch=-0.08, roll=0;
      let yawT=0, pitchT=-0.08, rollT=0;
      function applyCamera(){
        const a=0.40;
        yaw += (yawT-yaw)*a;
        pitch += (pitchT-pitch)*a;
        roll += (rollT-roll)*0.25;
        pitch=THREE.MathUtils.clamp(pitch,-0.55,0.35);
        const radius=camera.position.z;
        const cx=0, cy=2.2, cz=0;
        camera.position.set(cx+Math.sin(yaw)*radius, cy+pitch*radius*0.9, cz+Math.cos(yaw)*radius);
        camera.lookAt(0,2.1,0);
        camera.rotation.z=roll;
      }

      let dragging=false, lastX=0, lastY=0;
      renderer.domElement.addEventListener("pointerdown",(ev)=>{
        dragging=true; lastX=ev.clientX; lastY=ev.clientY;
      },{passive:true});
      window.addEventListener("pointerup",()=>dragging=false,{passive:true});
      window.addEventListener("pointermove",(ev)=>{
        if(!dragging) return;
        const dx=(ev.clientX-lastX)/Math.max(280, window.innerWidth);
        const dy=(ev.clientY-lastY)/Math.max(280, window.innerHeight);
        lastX=ev.clientX; lastY=ev.clientY;
        yawT += dx*(Math.PI*2.2);
        pitchT += dy*(Math.PI*1.1);
      },{passive:true});

      function onResize(){
        renderer.setSize(window.innerWidth, window.innerHeight);
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        applyResponsive();
      }
      window.addEventListener("resize", onResize, {passive:true});
      window.addEventListener("orientationchange", ()=>setTimeout(onResize,200), {passive:true});
      applyResponsive();

      // çŠ¶æ€ï¼šåˆæ‹¢/æ•£å¼€
      let stateTarget="compact";
      let mix=0, mixVel=0;
      function smoothDamp(current, target, currentVelocity, smoothTime, dt){
        smoothTime=Math.max(0.0001,smoothTime);
        const omega=2/smoothTime;
        const x=omega*dt;
        const exp=1/(1+x+0.48*x*x+0.235*x*x*x);
        let change=current-target;
        const temp=(currentVelocity+omega*change)*dt;
        currentVelocity=(currentVelocity-omega*temp)*exp;
        const output=target+(change+temp)*exp;
        return {value:output, vel:currentVelocity};
      }

      let last=performance.now();
      function tick(now){
        const dt=Math.min(0.033,(now-last)/1000);
        last=now;

        const targetMix = (stateTarget==="scatter") ? 1 : 0;
        const sd = smoothDamp(mix, targetMix, mixVel, 0.38, dt);
        mix = sd.value; mixVel = sd.vel;

        // ç¯ä¸²ï¼šåˆæ‹¢æ›´æ ‡å‡†ï¼Œæ•£å¼€æ›´æµåŠ¨
        tick._acc = (tick._acc||0)+dt;
        if(tick._acc>0.085){
          tick._acc=0;
          rebuildHelix(1-mix, now/1000);
        }

        for(const e of elements){
          const obj=e.obj;
          const pos=e.compact.clone().lerp(e.scatter, mix);
          if(mix>0.02){
            const w=e.wob;
            pos.x += Math.sin(now*0.0009+w.x*6.0)*0.08*mix;
            pos.y += Math.cos(now*0.0008+w.y*6.0)*0.07*mix;
            pos.z += Math.sin(now*0.0007+w.z*6.0)*0.08*mix;
          }
          obj.position.lerp(pos, 0.18 + mix*0.08);
          obj.rotation.x = e.baseRot.x + Math.sin(now*0.0006+e.wob.x*6.0)*0.25*mix;
          obj.rotation.y = e.baseRot.y + Math.cos(now*0.00055+e.wob.y*6.0)*0.22*mix;
          obj.rotation.z = e.baseRot.z + Math.sin(now*0.0005+e.wob.z*6.0)*0.16*mix;
        }

        star.rotation.y += dt*0.55*(0.2+(1-mix)*0.8);
        star.material.emissiveIntensity = 0.95 + Math.sin(now*0.0016)*0.12;

        applyCamera();
        renderer.render(scene, camera);
        requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);

      // ç‚¹å‡»é¡µé¢å°è¯•æ¢å¤éŸ³é¢‘ï¼ˆæ‰‹æœºå¸¸éœ€è¦ï¼‰
      window.addEventListener("pointerdown", ()=>{
        if(musicOn && bgm.paused) bgm.play().catch(()=>{});
      }, {passive:true});

      // å¼€å§‹ä½“éªŒæŒ‰é’®ï¼šä¿è¯ä¸€å®šæœ‰åé¦ˆ
      startBtn.addEventListener("click", async ()=>{
        startBtn.disabled=true;
        startBtn.textContent="å¯åŠ¨ä¸­â€¦";
        setStatus("å·²æ”¶åˆ°ç‚¹å‡»ï¼šæ­£åœ¨å¼€å¯éŸ³ä¹ä¸æ‘„åƒå¤´æƒé™â€¦");

        if(!musicOn){ setMusic(true); updateMusicUI(); }
        await startCamera();

        // è¿›å…¥ä½“éªŒ
        startOverlay.classList.add("hide");
        startBtn.disabled=false;
        startBtn.textContent="å¼€å§‹ä½“éªŒï¼ˆç‚¹æˆ‘ï¼‰";
        toast("å·²è¿›å…¥ä½“éªŒï¼šæ‹–åŠ¨å±å¹•æ—‹è½¬è§†è§’", 1800);
      });

      // å°å½©è›‹ï¼šåŒå‡»åˆ‡æ¢åˆæ‹¢/æ•£å¼€
      renderer.domElement.addEventListener("dblclick", ()=>{
        stateTarget = (stateTarget==="compact") ? "scatter" : "compact";
        toast(stateTarget==="compact" ? "åˆæ‹¢æ€" : "æ•£å¼€æ€", 1200);
      });

      setStatus("å·²ä¿®å¤èºæ—‹ç¯çº¿å´©æºƒ âœ…\nç°åœ¨ç‚¹æŒ‰é’®åº”è¯¥ä¼šæœ‰ååº”ã€‚");
      updateCamUI();
      updateMusicUI();
    })();
  </script>
</body>
</html>
