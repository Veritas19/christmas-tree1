<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ç²’å­åœ£è¯æ ‘ Â· æ‰‹åŠ¿äº¤äº’</title>
  <style>
    :root{
      --gold:#f7d46b;
      --gold2:#ffd36a;
      --red:#ff2a2a;
      --green:#0b2b1e;
      --warm:#ffddb0;
      --panel: rgba(12, 16, 18, .38);
      --panel2: rgba(12,16,18,.55);
      --stroke: rgba(255,255,255,.22);
    }
    html,body{height:100%;margin:0;background:#07090b;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;}
    #app{position:fixed;inset:0;touch-action:none;}
    canvas{display:block;width:100%;height:100%;}

    /* é¡¶éƒ¨çŠ¶æ€æ¡ */
    #hud{
      position:fixed; left:12px; top:12px;
      display:flex; flex-direction:column; gap:10px;
      z-index:10; max-width:min(520px, calc(100% - 24px));
      pointer-events:none;
    }
    .row{
      pointer-events:auto;
      background:var(--panel);
      border:1px solid var(--stroke);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius:14px;
      padding:10px 12px;
      color:#fff;
      box-shadow:0 12px 30px rgba(0,0,0,.35);
    }
    .row h1{
      margin:0 0 6px 0; font-size:14px; font-weight:700; letter-spacing:.2px;
      display:flex; align-items:center; gap:8px;
    }
    .row p{margin:6px 0 0 0; font-size:12px; line-height:1.45; opacity:.92}
    .kv{display:flex; flex-wrap:wrap; gap:10px; font-size:12px; opacity:.95}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.14);
    }
    .dot{width:9px;height:9px;border-radius:99px;background:#666; box-shadow:0 0 10px rgba(255,255,255,.2)}
    .dot.on{background:#6cff9b; box-shadow:0 0 14px rgba(108,255,155,.65)}
    .dot.warn{background:#ffd36a; box-shadow:0 0 14px rgba(255,211,106,.55)}
    .dot.off{background:#888; box-shadow:0 0 10px rgba(255,255,255,.18)}
    .btn{
      pointer-events:auto;
      border:none; cursor:pointer;
      border-radius:14px;
      padding:10px 12px;
      font-weight:800;
      color:#1c1406;
      background:linear-gradient(180deg, #ffe39b, #f7c857);
      box-shadow:0 16px 40px rgba(247,200,87,.22), 0 10px 22px rgba(0,0,0,.25);
    }
    .btn:active{transform:translateY(1px)}
    .btn.small{padding:8px 10px;border-radius:12px;font-weight:800}
    .btn.ghost{
      color:#fff; background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      box-shadow:none;
    }

    /* ä¸Šä¼ æ§ä»¶ */
    #uploader{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-top:8px;
    }
    #pickPhotos{
      pointer-events:auto;
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 12px; border-radius:14px;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      color:#fff; font-weight:800; cursor:pointer;
    }
    #fileHint{font-size:12px; opacity:.9}
    #thumbs{
      display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;
    }
    .thumb{
      width:40px; height:40px; border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.25);
      overflow:hidden;
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}

    /* å¼€å§‹ä½“éªŒå¤§æŒ‰é’® */
    #startOverlay{
      position:fixed; inset:0; z-index:20;
      display:grid; place-items:center;
      background:
        radial-gradient(1200px 700px at 50% 35%, rgba(255,205,140,.18), transparent 55%),
        radial-gradient(900px 600px at 50% 60%, rgba(255,210,120,.10), transparent 55%),
        linear-gradient(180deg, #050608, #090b10 55%, #050608);
    }
    #startCard{
      width:min(560px, calc(100% - 26px));
      border-radius:22px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(10,12,14,.50);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow:0 28px 80px rgba(0,0,0,.55);
      padding:18px 18px 16px;
      color:#fff;
      text-align:center;
    }
    #startCard h2{margin:4px 0 10px;font-size:18px;letter-spacing:.3px}
    #startCard p{margin:0 0 14px;opacity:.92;font-size:13px;line-height:1.55}
    #startBig{
      width:100%;
      padding:16px 14px;
      border-radius:18px;
      font-size:18px;
      font-weight:900;
      letter-spacing:.6px;
      color:#1c1406;
      background:linear-gradient(180deg, #ffe7a8, #f6c24e);
      border:none; cursor:pointer;
      box-shadow:0 22px 60px rgba(246,194,78,.25), 0 12px 24px rgba(0,0,0,.25);
    }
    #startBig:active{transform:translateY(1px)}
    #startNote{margin-top:12px; font-size:12px; opacity:.88}
    #startNote b{color:#ffd36a}

    /* ç…§ç‰‡æ”¾å¤§æ€ï¼ˆDOM å å±‚ï¼Œç¡®ä¿æ­£é¢å®Œæ•´+é«˜æ¸…ï¼‰ */
    #photoStage{
      position:fixed; inset:0; z-index:30;
      display:none;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      align-items:center; justify-content:center;
      padding:16px;
    }
    #photoWrap{
      width:min(880px, calc(100% - 20px));
      max-height:min(82vh, 820px);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(15,16,18,.55);
      box-shadow:0 30px 90px rgba(0,0,0,.62);
      overflow:hidden;
      position:relative;
    }
    #photoWrap::before{
      content:"";
      position:absolute; inset:-40px;
      background: radial-gradient(380px 220px at 35% 18%, rgba(255,210,120,.35), transparent 60%),
                  radial-gradient(420px 240px at 65% 22%, rgba(255,80,80,.20), transparent 60%),
                  radial-gradient(520px 380px at 50% 90%, rgba(120,255,190,.12), transparent 62%);
      filter: blur(18px);
      opacity:.7;
    }
    #photoImg{
      position:relative;
      width:100%;
      height:100%;
      max-height:82vh;
      object-fit:contain;
      display:block;
      background:rgba(0,0,0,.18);
    }
    #photoTip{
      position:absolute; left:14px; bottom:12px; right:14px;
      color:#fff; font-size:12px; opacity:.9;
      text-align:center;
      pointer-events:none;
      text-shadow:0 2px 10px rgba(0,0,0,.55);
    }

    /* é”™è¯¯æç¤º */
    #toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      z-index:40;
      display:none;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(0,0,0,.62);
      color:#fff;
      border:1px solid rgba(255,255,255,.16);
      font-size:12px;
      max-width:min(720px, calc(100% - 20px));
      text-align:center;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    /* éšè—è§†é¢‘ */
    #video{
      position:fixed; right:10px; bottom:10px; width:1px; height:1px; opacity:0;
      pointer-events:none;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <div id="hud">
    <div class="row">
      <h1>ğŸ„ ç²’å­åœ£è¯æ ‘ Â· æ‰‹åŠ¿äº¤äº’</h1>
      <div class="kv">
        <span class="badge"><span id="camDot" class="dot off"></span>æ‘„åƒå¤´ï¼š<b id="camTxt">å…³é—­</b></span>
        <span class="badge"><span id="bgmDot" class="dot off"></span>éŸ³ä¹ï¼š<b id="bgmTxt">å…³é—­</b></span>
        <span class="badge"><span id="handDot" class="dot warn"></span>æ‰‹åŠ¿ï¼š<b id="handTxt">å¾…å¯åŠ¨</b></span>
      </div>

      <div id="uploader">
        <label id="pickPhotos" for="photoInput">â¬†ï¸ ä¸Šä¼ ç…§ç‰‡(â‰¤7)</label>
        <span id="fileHint">æœªé€‰æ‹©æ–‡ä»¶</span>
        <button id="replayBtn" class="btn small ghost" type="button">é‡æ–°æ’­æ”¾éŸ³ä¹</button>
        <button id="recamBtn" class="btn small ghost" type="button">é‡æ–°å¼€å¯æ‘„åƒå¤´</button>
      </div>
      <input id="photoInput" type="file" accept="image/*" multiple style="display:none" />
      <div id="thumbs"></div>

      <p style="margin-top:10px">
        æ‰‹åŠ¿ï¼šæ¡æ‹³â†’åˆæ‹¢ï¼›äº”æŒ‡å¼ å¼€â†’æ•£å¼€ï¼›æ•£å¼€æ—¶ç§»åŠ¨æ‰‹â†’æ—‹è½¬è§†è§’ï¼ˆå¹…åº¦è·Ÿéšï¼‰ï¼›<br/>
        <b>æ‹‡æŒ‡+é£ŸæŒ‡æåˆ</b>â†’æŠ“å–æ”¾å¤§ç…§ç‰‡ï¼Œåˆ†å¼€â†’å›åŸä½ã€‚<br/>
        ï¼ˆè‹¥æ‰‹åŠ¿åº“åŠ è½½å¤±è´¥ï¼Œä¹Ÿå¯ç”¨ <b>æ‰‹æŒ‡/é¼ æ ‡æ‹–åŠ¨</b> æ—‹è½¬è§†è§’ï¼‰
      </p>
    </div>
  </div>

  <div id="startOverlay">
    <div id="startCard">
      <h2>âœ¨ åœ£è¯æ ‘ Â· å¼€å§‹ä½“éªŒ</h2>
      <p>ç‚¹ä¸€æ¬¡å°±ä¼šå°è¯•æ’­æ”¾åœ£è¯ BGMï¼Œå¹¶è¯·æ±‚æ‘„åƒå¤´æƒé™ç”¨äºæ‰‹åŠ¿äº¤äº’ã€‚<br/>ï¼ˆä¸æƒ³å¼€æ‘„åƒå¤´ä¹Ÿå¯ä»¥åªçœ‹è§†è§‰æ•ˆæœï¼‰</p>
      <button id="startBig">å¼€å§‹ä½“éªŒï¼ˆç‚¹æˆ‘ï¼‰</button>
      <div id="startNote">
        å¦‚æœä½ åœ¨å¾®ä¿¡/QQå†…æ‰“å¼€ï¼šè¯·ç‚¹å³ä¸Šè§’ <b>ç”¨æµè§ˆå™¨æ‰“å¼€</b>ï¼ˆå†…ç½®æµè§ˆå™¨å¸¸æ‹¦æ‘„åƒå¤´/éŸ³é¢‘/å¤–é“¾èµ„æºï¼‰ã€‚
      </div>
    </div>
  </div>

  <div id="photoStage">
    <div id="photoWrap">
      <img id="photoImg" alt="photo" />
      <div id="photoTip">æåˆä¿æŒæ”¾å¤§ Â· æ¾å¼€å›åŸä½</div>
    </div>
  </div>

  <div id="toast"></div>
  <video id="video" playsinline></video>

  <script>
  (function(){
    const $ = (id)=>document.getElementById(id);

    const toast = $("toast");
    function showToast(msg, ms=2400){
      toast.textContent = msg;
      toast.style.display="block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.style.display="none", ms);
    }

    // ========= 0) èµ„æºåŠ è½½ï¼šThree.js ä¼˜å…ˆæœ¬åœ° =========
    function loadScript(url){
      return new Promise((resolve, reject)=>{
        const s=document.createElement("script");
        s.src=url;
        s.onload=()=>resolve(url);
        s.onerror=()=>reject(new Error("load failed: "+url));
        document.head.appendChild(s);
      });
    }

    async function ensureThree(){
      const candidates = [
        "./libs/three.min.js", // âœ… ä½ çš„ä»“åº“æœ¬åœ°
        "https://cdnjs.cloudflare.com/ajax/libs/three.js/r155/three.min.js",
        "https://unpkg.com/three@0.155.0/build/three.min.js"
      ];
      for (const url of candidates){
        try{
          await loadScript(url);
          if (window.THREE) return url;
        }catch(e){}
      }
      throw new Error("Three.js æœªåŠ è½½æˆåŠŸï¼ˆè¯·æŠŠ three.min.js æ”¾åˆ°ä»“åº“ /libs ç›®å½•ï¼‰");
    }

    // ========= 1) éŸ³ä¹ï¼šä¼˜å…ˆæœ¬åœ° Jingle Bell Rockï¼Œå…œåº•å…¬å¼€BGM =========
    const AUDIO_SOURCES = [
      "./assets/jingle-bell-rock.mp3", // ä½ æƒ³è¦çš„â€œç»å…¸Jingle Bell Rockâ€ï¼šè¯·æ”¾åˆ°ä»“åº“ assets
      // å…œåº•ï¼šå…¬å¼€å¯ç”¨ï¼ˆCC BY 3.0ï¼ŒKevin MacLeod çš„åœ£è¯æ›²ç›®ï¼‰
      "https://upload.wikimedia.org/wikipedia/commons/8/8a/Jingle_Bells_%28Calm%29_%28ISRC_USUAN1100188%29.mp3"
    ];

    let audioEl=null, audioCtx=null, gainNode=null;
    async function tryPlayBGM(){
      try{
        if (!audioEl){
          audioEl = new Audio();
          audioEl.loop = true;
          audioEl.preload = "auto";
          audioEl.crossOrigin = "anonymous";
        }

        // WebAudioï¼šæ›´â€œä¸æ»‘â€çš„æ·¡å…¥
        if (!audioCtx){
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          const src = audioCtx.createMediaElementSource(audioEl);
          gainNode = audioCtx.createGain();
          gainNode.gain.value = 0.0;
          src.connect(gainNode).connect(audioCtx.destination);
        }
        await audioCtx.resume();

        // ä¾æ¬¡å°è¯•éŸ³æº
        let ok=false;
        for (const src of AUDIO_SOURCES){
          try{
            audioEl.src = src;
            await audioEl.play(); // iOS å¿…é¡»åœ¨ç”¨æˆ·ç‚¹å‡»åè°ƒç”¨
            ok=true;
            break;
          }catch(e){}
        }
        if (!ok) throw new Error("éŸ³ä¹æ’­æ”¾å¤±è´¥ï¼ˆå¯èƒ½è¢«æµè§ˆå™¨ç­–ç•¥æ‹¦æˆªï¼‰");

        // æ·¡å…¥
        const target=0.62;
        const t0=performance.now();
        const fade= (t)=>{
          const k=Math.min(1,(t-t0)/1200);
          gainNode.gain.value = target*(k*k*(3-2*k));
          if (k<1) requestAnimationFrame(fade);
        };
        requestAnimationFrame(fade);

        $("bgmDot").className="dot on";
        $("bgmTxt").textContent="å¼€å¯";
        return true;
      }catch(e){
        $("bgmDot").className="dot warn";
        $("bgmTxt").textContent="æœªå¼€å¯";
        showToast("éŸ³ä¹æ²¡æ’­æ”¾å‡ºæ¥ï¼šè¯·å†ç‚¹ä¸€æ¬¡â€œé‡æ–°æ’­æ”¾éŸ³ä¹â€ï¼ˆæˆ–æ£€æŸ¥æ˜¯å¦é™éŸ³/ä½ç”µé‡æ¨¡å¼ï¼‰", 3200);
        return false;
      }
    }

    // ========= 2) æ‘„åƒå¤´ =========
    let mediaStream=null;
    async function tryOpenCamera(){
      try{
        const video = $("video");
        if (mediaStream){
          mediaStream.getTracks().forEach(t=>t.stop());
          mediaStream=null;
        }
        mediaStream = await navigator.mediaDevices.getUserMedia({
          video:{
            facingMode:"user",
            width:{ideal: 1280},
            height:{ideal: 720}
          },
          audio:false
        });
        video.srcObject = mediaStream;
        await video.play();

        $("camDot").className="dot on";
        $("camTxt").textContent="å¼€å¯";
        return true;
      }catch(e){
        $("camDot").className="dot warn";
        $("camTxt").textContent="æœªå¼€å¯";
        showToast("æ‘„åƒå¤´å¼€å¯å¤±è´¥ï¼šè¯·ç”¨ç³»ç»Ÿæµè§ˆå™¨æ‰“å¼€å¹¶å…è®¸æƒé™ï¼ˆå¾®ä¿¡/QQå†…ç½®æµè§ˆå™¨å¸¸å¤±è´¥ï¼‰", 3800);
        return false;
      }
    }

    // ========= 3) æ‰‹åŠ¿ï¼ˆMediaPipe Handsï¼šå¯ç”¨åˆ™å¯ç”¨ï¼Œä¸å¯ç”¨åˆ™é™çº§è§¦æ§ï¼‰ =========
    let hands=null, mpCamera=null;
    let handReady=false;

    async function loadMediaPipeHands(){
      // å¤šä¸ªå€™é€‰æºï¼ˆé¿å…æŸä¸ªCDNæŒ‚æ‰ï¼‰
      const candidates = [
        // unpkg é€šå¸¸æ¯” jsdelivr æ›´å®¹æ˜“é€š
        {
          hands:"https://unpkg.com/@mediapipe/hands/hands.js",
          cam :"https://unpkg.com/@mediapipe/camera_utils/camera_utils.js",
          base:"https://unpkg.com/@mediapipe/hands/"
        },
        {
          hands:"https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js",
          cam :"https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js",
          base:"https://cdn.jsdelivr.net/npm/@mediapipe/hands/"
        }
      ];

      for (const c of candidates){
        try{
          await loadScript(c.cam);
          await loadScript(c.hands);
          if (!window.Hands || !window.Camera) throw new Error("mp objects missing");
          return c.base;
        }catch(e){}
      }
      throw new Error("æ‰‹åŠ¿åº“åŠ è½½å¤±è´¥ï¼ˆç½‘ç»œå¯èƒ½æ‹¦æˆªå¤–é“¾ï¼‰");
    }

    // æ‰‹åŠ¿è§£æï¼šæ›´æ¸…æ¥š + é˜²æŠ–
    const GEST = { NONE:0, FIST:1, OPEN:2, PINCH:3, MOVE:4 };
    let lastLm=null;

    function dist(a,b){
      const dx=a.x-b.x, dy=a.y-b.y, dz=(a.z||0)-(b.z||0);
      return Math.hypot(dx,dy,dz);
    }
    function isFingerExtended(lm, tip, pip){
      // tip ç¦» wrist æ›´è¿œ â†’ ä¼¸ç›´ï¼ˆå¯¹ä¸åŒæ–¹å‘æ›´ç¨³ï¼‰
      const wrist=lm[0];
      return dist(lm[tip], wrist) > dist(lm[pip], wrist) + 0.02;
    }
    function classifyGesture(lm){
      const wrist=lm[0];
      const thumbTip=lm[4], indexTip=lm[8];
      const pinchD = dist(thumbTip, indexTip);

      // æ‰‹æŒå°ºåº¦
      const palm = dist(lm[0], lm[9]) + 1e-6;

      // PINCHï¼šç›¸å¯¹å°ºåº¦é˜ˆå€¼
      const pinch = pinchD < palm*0.28;

      const iExt = isFingerExtended(lm, 8, 6);
      const mExt = isFingerExtended(lm,12,10);
      const rExt = isFingerExtended(lm,16,14);
      const pExt = isFingerExtended(lm,20,18);

      const open = (iExt && mExt && rExt && pExt) && !pinch;
      const fist = (!iExt && !mExt && !rExt && !pExt) && !pinch;

      if (pinch) return GEST.PINCH;
      if (open)  return GEST.OPEN;
      if (fist)  return GEST.FIST;
      return GEST.MOVE;
    }

    // é˜²æŠ–ï¼šåŒä¸€æ‰‹åŠ¿è¿ç»­ N å¸§æ‰è®¤å®š
    let gestStable=GEST.NONE, gestCount=0;
    function updateStableGesture(lm){
      const g=classifyGesture(lm);
      if (g===gestStable){
        gestCount = Math.min(30, gestCount+1);
      }else{
        gestStable = g;
        gestCount = 1;
      }
      // éœ€è¦è¿ç»­ 6 å¸§ï¼ˆæ›´æ¸…æ¥šï¼Œä¸ä¹±è·³ï¼‰
      return (gestCount>=6) ? gestStable : GEST.NONE;
    }

    // ========= 4) Three åœºæ™¯ï¼šå†™å®æš–è‰² + é‡‘çº¢çƒ + æ ‡å‡†èºæ—‹é‡‘çº¿ + æ˜Ÿæ˜Ÿ =========
    let scene, camera, renderer;
    let root, treeGroup, ornamentsGroup, photosGroup, fogGroup, helixGroup, starMesh;
    let raycaster, ndc=new THREE.Vector2();

    // çŠ¶æ€
    const STATE = { COMPACT:0, SCATTER:1, PHOTO:2 };
    let state = STATE.COMPACT;
    let spread = 0; // 0=åˆæ‹¢ 1=æ•£å¼€
    let targetSpread = 0;

    // è§†è§’æ§åˆ¶ï¼ˆæ‰‹åŠ¿/æ‹–åŠ¨éƒ½å†™åˆ°åŒä¸€å¥—ï¼‰
    let yaw=0, pitch=0;
    let yawVel=0, pitchVel=0;
    let roll=0;
    let lastHandX=null, lastHandY=null;

    // æ‹–åŠ¨ï¼ˆé™çº§è§¦æ§/é¼ æ ‡ï¼‰
    let dragging=false, lastPX=0, lastPY=0;

    // ç…§ç‰‡
    const MAX_PHOTOS=7;
    const photoPlanes=[];
    const photoTargets=[]; // {compact:Vector3, scatter:Vector3, layer:number, angle:number}
    const photoUrls=[];
    let selectedPhoto=null;
    let pinchHolding=false;

    function clamp(v,a,b){return Math.max(a,Math.min(b,v))}
    function smoothstep(t){return t*t*(3-2*t)}

    function makeRadialTexture(colorA, colorB){
      const c=document.createElement("canvas");
      c.width=c.height=128;
      const g=c.getContext("2d");
      const grd=g.createRadialGradient(64,64,0,64,64,64);
      grd.addColorStop(0, colorA);
      grd.addColorStop(1, colorB);
      g.fillStyle=grd;
      g.fillRect(0,0,128,128);
      const tex=new THREE.CanvasTexture(c);
      tex.needsUpdate=true;
      return tex;
    }

    function buildStar(){
      // æ›´æ˜æ˜¾ã€è§’æ›´å°–çš„äº”è§’æ˜Ÿ
      const shape = new THREE.Shape();
      const R=1.0, r=0.42;
      const pts=[];
      for(let i=0;i<10;i++){
        const ang = -Math.PI/2 + i*(Math.PI/5);
        const rad = (i%2===0)?R:r;
        pts.push(new THREE.Vector2(Math.cos(ang)*rad, Math.sin(ang)*rad));
      }
      shape.moveTo(pts[0].x, pts[0].y);
      for(let i=1;i<pts.length;i++) shape.lineTo(pts[i].x, pts[i].y);
      shape.closePath();

      const geo = new THREE.ExtrudeGeometry(shape,{
        depth:0.22,
        bevelEnabled:true,
        bevelThickness:0.08,
        bevelSize:0.06,
        bevelSegments:2
      });
      geo.center();

      const mat = new THREE.MeshStandardMaterial({
        color:0xffc54d, metalness:0.95, roughness:0.18,
        emissive:0x3b2200, emissiveIntensity:0.55
      });
      const m = new THREE.Mesh(geo, mat);
      m.scale.setScalar(0.55);
      return m;
    }

    function makeHelixCurve(height, radius, turns){
      const pts=[];
      const seg=220;
      for(let i=0;i<=seg;i++){
        const t=i/seg;
        const ang = t*turns*Math.PI*2;
        const y = (t-0.5)*height;
        const r = radius*(0.92 - 0.18*t);
        pts.push(new THREE.Vector3(Math.cos(ang)*r, y, Math.sin(ang)*r));
      }
      return new THREE.CatmullRomCurve3(pts);
    }

    function buildScene(){
      scene = new THREE.Scene();

      // æš–è‰²ç”µå½±æ„ŸèƒŒæ™¯ï¼ˆä¸ç”¨åå¤„ç†ä¹Ÿèƒ½æš–ï¼‰
      scene.fog = new THREE.FogExp2(0x07090b, 0.035);

      camera = new THREE.PerspectiveCamera(52, innerWidth/innerHeight, 0.05, 80);
      camera.position.set(0, 1.15, 5.2);

      renderer = new THREE.WebGLRenderer({antialias:true, alpha:false});
      renderer.setSize(innerWidth, innerHeight);
      renderer.setPixelRatio(Math.min(devicePixelRatio||1, 2));
      renderer.outputColorSpace = THREE.SRGBColorSpace;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.25; // âœ… äº®ä¸€äº›ã€æš–ä¸€äº›

      $("app").appendChild(renderer.domElement);

      raycaster = new THREE.Raycaster();

      root = new THREE.Group();
      scene.add(root);

      // ç¯å…‰ï¼šæš–è‰²ä¸»è°ƒ + é‡‘è‰²é«˜å…‰
      const amb = new THREE.AmbientLight(0xffe2bf, 0.62);
      scene.add(amb);

      const key = new THREE.DirectionalLight(0xfff0d2, 0.85);
      key.position.set(2.6, 4.0, 2.0);
      scene.add(key);

      const fill = new THREE.PointLight(0xffcc88, 1.2, 25, 2);
      fill.position.set(-2.5, 2.0, 3.0);
      scene.add(fill);

      const rim = new THREE.PointLight(0xffd36a, 0.9, 25, 2);
      rim.position.set(2.8, 1.2, -3.2);
      scene.add(rim);

      // ===== æ ‘ä½“ï¼šåˆ†æå±‚çº§ç²’å­ + ä½“ç§¯å…‰é›¾ =====
      treeGroup = new THREE.Group();
      ornamentsGroup = new THREE.Group();
      photosGroup = new THREE.Group();
      fogGroup = new THREE.Group();
      helixGroup = new THREE.Group();
      root.add(treeGroup, helixGroup, ornamentsGroup, photosGroup, fogGroup);

      // åˆ†æç²’å­ï¼ˆåå“‘å…‰ç»¿ï¼‰
      const branchPoints=[];
      function addBranch(level, start, dir, len){
        const seg = 18;
        for(let i=0;i<=seg;i++){
          const t=i/seg;
          const p = start.clone().add(dir.clone().multiplyScalar(len*t));
          // è®©æå¶æœ‰ä½“ç§¯ï¼šåœ¨æå‘¨å›´æŠ–åŠ¨
          const jitter = 0.06 + 0.10*(1-t) + 0.04*level;
          p.x += (Math.random()-0.5)*jitter;
          p.y += (Math.random()-0.5)*jitter*0.45;
          p.z += (Math.random()-0.5)*jitter;
          branchPoints.push(p);
        }
        if(level<=0) return;
        const childN = 2 + (Math.random()<0.35 ? 1 : 0);
        for(let k=0;k<childN;k++){
          const nd = dir.clone();
          nd.x += (Math.random()-0.5)*0.9;
          nd.y += 0.75 + Math.random()*0.55;
          nd.z += (Math.random()-0.5)*0.9;
          nd.normalize();
          const nl = len*(0.55 + Math.random()*0.18);
          addBranch(level-1, start.clone().add(dir.clone().multiplyScalar(len*(0.55+Math.random()*0.25))), nd, nl);
        }
      }
      // ä¸»å¹² + åˆ†æ
      addBranch(3, new THREE.Vector3(0,-1.25,0), new THREE.Vector3(0,1,0), 2.6);

      const leafGeom = new THREE.BufferGeometry().setFromPoints(branchPoints);
      const leafMat = new THREE.PointsMaterial({
        color:0x1c6f4a,
        size:0.035,
        transparent:true,
        opacity:0.82,
        depthWrite:false,
        blending:THREE.AdditiveBlending
      });
      const leafPts = new THREE.Points(leafGeom, leafMat);
      treeGroup.add(leafPts);

      // ä½“ç§¯å…‰é›¾ï¼ˆæš–é‡‘+å¾®ç»¿ï¼‰
      const fogTex = makeRadialTexture("rgba(255,220,170,.52)", "rgba(10,12,14,0)");
      const fogCount = 180;
      for(let i=0;i<fogCount;i++){
        const sp = new THREE.Sprite(new THREE.SpriteMaterial({
          map:fogTex,
          color: (Math.random()<0.6)?0xffe0b8:0xa8ffd0,
          transparent:true,
          opacity: 0.13 + Math.random()*0.11,
          depthWrite:false,
          blending:THREE.AdditiveBlending
        }));
        const y = -1.15 + Math.random()*3.0;
        const r = (1.0 - (y+1.15)/3.0) * (0.95 + Math.random()*0.35);
        const a = Math.random()*Math.PI*2;
        sp.position.set(Math.cos(a)*r, y, Math.sin(a)*r);
        const s = 0.55 + Math.random()*1.15;
        sp.scale.set(s, s, 1);
        fogGroup.add(sp);
      }

      // ===== è£…é¥°çƒï¼šåªäº®é‡‘/äº®çº¢ =====
      const goldMat = new THREE.MeshStandardMaterial({color:0xffd36a, metalness:0.95, roughness:0.20, emissive:0x2b1a00, emissiveIntensity:0.35});
      const redMat  = new THREE.MeshStandardMaterial({color:0xff2a2a, metalness:0.65, roughness:0.30, emissive:0x330000, emissiveIntensity:0.22});
      const ballGeo = new THREE.SphereGeometry(0.085, 18, 18);

      const balls=72;
      for(let i=0;i<balls;i++){
        const m = new THREE.Mesh(ballGeo, (Math.random()<0.55)?goldMat:redMat);
        // åˆ†å±‚æ”¾ç½®
        const layer = i%6;
        const t = (i/(balls-1));
        const y = -1.0 + t*2.55;
        const radius = (1.08 - t*0.95) * (0.95 + (layer%2)*0.06);
        const ang = (i*0.61803398875*2*Math.PI) + (layer*0.35);
        m.position.set(Math.cos(ang)*radius, y, Math.sin(ang)*radius);
        m.userData.compact = m.position.clone();
        // æ•£å¼€æ€éšæœºæ¼‚æµ®
        m.userData.scatter = new THREE.Vector3(
          (Math.random()-0.5)*5.2,
          (Math.random()-0.5)*3.4,
          (Math.random()-0.5)*5.2
        );
        ornamentsGroup.add(m);
      }

      // ===== æ ‘é¡¶æ˜Ÿæ˜Ÿ =====
      starMesh = buildStar();
      starMesh.position.set(0, 1.62, 0);
      starMesh.userData.compact = starMesh.position.clone();
      starMesh.userData.scatter = new THREE.Vector3(0.2, 1.2, -0.6);
      root.add(starMesh);

      // ===== ç¯ä¸²ï¼šåˆæ‹¢æ€æ ‡å‡†èºæ—‹â€œçº¿â€ï¼Œæ•£å¼€æ€éšæ„æµåŠ¨ =====
      const helixCurve = makeHelixCurve(3.1, 1.12, 7.6);
      const tubeGeo = new THREE.TubeGeometry(helixCurve, 320, 0.015, 10, false);
      const tubeMat = new THREE.MeshBasicMaterial({
        color:0xffea74, transparent:true, opacity:0.62
      });
      const tube = new THREE.Mesh(tubeGeo, tubeMat);
      helixGroup.add(tube);

      // ç¯ç  + è¾‰å…‰
      const glowTex = makeRadialTexture("rgba(255,240,190,.95)", "rgba(0,0,0,0)");
      const bulbs=160;
      for(let i=0;i<bulbs;i++){
        const t=i/(bulbs-1);
        const p = helixCurve.getPointAt(t);
        const bulb = new THREE.Mesh(
          new THREE.SphereGeometry(0.018, 10, 10),
          new THREE.MeshBasicMaterial({color:0xfff2b0, transparent:true, opacity:0.95})
        );
        bulb.position.copy(p);
        helixGroup.add(bulb);

        const glow = new THREE.Sprite(new THREE.SpriteMaterial({
          map:glowTex, color:0xffd36a, transparent:true, opacity:0.55,
          depthWrite:false, blending:THREE.AdditiveBlending
        }));
        glow.position.copy(p);
        glow.scale.set(0.22,0.22,1);
        helixGroup.add(glow);
      }

      // ===== ç…§ç‰‡å ä½ï¼ˆå…ˆå»º7å¼ ï¼Œåç»­æ¢è´´å›¾ï¼‰ =====
      const planeGeo = new THREE.PlaneGeometry(0.62, 0.42);
      for(let i=0;i<MAX_PHOTOS;i++){
        const mat = new THREE.MeshBasicMaterial({
          color:0xffffff,
          transparent:true,
          opacity:0.98,
          side:THREE.DoubleSide
        });
        const plane = new THREE.Mesh(planeGeo, mat);
        plane.userData.index=i;
        plane.userData.baseScale=1;
        planePlanesInit(plane, i);
        photosGroup.add(plane);
        photoPlanes.push(plane);
      }

      // è®©æ ‘æ•´ä½“æ›´â€œé«˜çº§â€ï¼šè½»å¾®é‡‘è‰²åœ°é¢åå…‰ï¼ˆå‡çš„ï¼Œç”¨å¤§å¹³é¢æ¸å˜ï¼‰
      const floorTex = makeRadialTexture("rgba(255,210,120,.14)", "rgba(0,0,0,0)");
      const floor = new THREE.Mesh(
        new THREE.PlaneGeometry(40,40),
        new THREE.MeshBasicMaterial({map:floorTex, transparent:true, opacity:0.55, depthWrite:false})
      );
      floor.rotation.x=-Math.PI/2;
      floor.position.y=-1.45;
      scene.add(floor);
    }

    function planePlanesInit(plane, i){
      // åˆ†å±‚ + å‘¨å‘å‡åŒ€ + æœ€å°é®æŒ¡ï¼ˆç®€åŒ–ç‰ˆä½†æ•ˆæœå¹²å‡€ï¼‰
      const layers = [
        {y:-0.70, n:3, r:1.05},
        {y: 0.10, n:2, r:0.78},
        {y: 0.86, n:2, r:0.56},
      ];
      let acc=0, layerIdx=0, slot=0;
      for(let li=0;li<layers.length;li++){
        const n=layers[li].n;
        if (i < acc+n){ layerIdx=li; slot=i-acc; break; }
        acc+=n;
      }
      const L=layers[layerIdx];
      const angStep = (Math.PI*2)/L.n;
      const ang = slot*angStep + (layerIdx*0.35);
      const pos = new THREE.Vector3(Math.cos(ang)*L.r, L.y, Math.sin(ang)*L.r);

      plane.position.copy(pos);
      plane.userData.compact = pos.clone();
      plane.userData.layer = layerIdx;
      plane.userData.ang = ang;

      // æ•£å¼€æ€ï¼šåˆ†æ•£ä½†é¿å…å¤ªæ‹¥æŒ¤
      const scatter = new THREE.Vector3(
        (Math.random()-0.5)*5.2,
        (Math.random()-0.5)*3.4 + 0.3,
        (Math.random()-0.5)*5.2
      );
      plane.userData.scatter = scatter;
      plane.userData.homePos = pos.clone();
      plane.userData.homeQuat = plane.quaternion.clone();

      photoTargets[i] = {compact:pos.clone(), scatter:scatter.clone(), layer:layerIdx, angle:ang};
    }

    function setState(next){
      if (state===next) return;
      state=next;

      if (state===STATE.COMPACT){
        targetSpread=0;
      }else if (state===STATE.SCATTER){
        targetSpread=1;
      }else if (state===STATE.PHOTO){
        // spread ä¿æŒåœ¨æ•£å¼€ï¼ˆèƒŒæ™¯æ¼‚æµ®æ›´æœ‰æ°›å›´ï¼‰
        targetSpread=1;
      }
    }

    function updateDots(){
      // æ‰‹åŠ¿çŠ¶æ€æ˜¾ç¤º
      $("handDot").className = handReady ? "dot on" : "dot warn";
      $("handTxt").textContent = handReady ? "å·²å¯ç”¨" : "è§¦æ§å¯ç”¨";
    }

    // ========= 5) ç…§ç‰‡ä¸Šä¼ ä¸è´´å›¾ =========
    function clearThumbs(){
      $("thumbs").innerHTML="";
    }
    function addThumb(url){
      const d=document.createElement("div");
      d.className="thumb";
      const img=document.createElement("img");
      img.src=url;
      d.appendChild(img);
      $("thumbs").appendChild(d);
    }

    function applyPhotoToPlane(i, url){
      const loader = new THREE.TextureLoader();
      loader.load(url, (tex)=>{
        tex.colorSpace = THREE.SRGBColorSpace;
        tex.anisotropy = Math.min(8, renderer.capabilities.getMaxAnisotropy());
        tex.needsUpdate=true;
        photoPlanes[i].material.map = tex;
        photoPlanes[i].material.needsUpdate=true;
      }, undefined, ()=>{
        // å¤±è´¥åˆ™ç”¨çº¯è‰²
      });
    }

    $("photoInput").addEventListener("change", ()=>{
      const files = $("photoInput").files;
      if (!files || !files.length){
        $("fileHint").textContent="æœªé€‰æ‹©æ–‡ä»¶";
        return;
      }
      const list = Array.from(files).slice(0, MAX_PHOTOS);
      $("fileHint").textContent = `å·²é€‰æ‹© ${list.length} å¼ `;
      clearThumbs();

      // é‡Šæ”¾æ—§URL
      while(photoUrls.length) URL.revokeObjectURL(photoUrls.pop());

      list.forEach((f, idx)=>{
        const url = URL.createObjectURL(f);
        photoUrls.push(url);
        addThumb(url);
        applyPhotoToPlane(idx, url);
      });

      // æ²¡é€‰æ»¡å°±ç»™å‰©ä½™å ä½æ¸å˜ï¼ˆä¸æ˜¾ç¤ºâ€œæœªé€‰æ‹©æ–‡ä»¶â€çš„å°´å°¬ï¼‰
      for(let i=list.length;i<MAX_PHOTOS;i++){
        photoPlanes[i].material.map = null;
        photoPlanes[i].material.color.setHex(0xffffff);
        photoPlanes[i].material.opacity = 0.28;
        photoPlanes[i].material.needsUpdate=true;
      }
    });

    // ========= 6) æ”¾å¤§æ€ï¼ˆDOM å å±‚ï¼‰ =========
    function showPhotoOverlay(url){
      if (!url) return;
      $("photoImg").src = url;
      $("photoStage").style.display="flex";
    }
    function hidePhotoOverlay(){
      $("photoStage").style.display="none";
      $("photoImg").src="";
    }

    // ========= 7) é€‰æ‹©/æŠ“å–ç…§ç‰‡ï¼ˆæåˆï¼‰ =========
    function pickPhotoByScreenXY(nx, ny){
      // nx,ny: 0..1ï¼ˆå±å¹•åæ ‡ï¼‰
      ndc.set(nx*2-1, -(ny*2-1));
      raycaster.setFromCamera(ndc, camera);
      const hits = raycaster.intersectObjects(photoPlanes, false);
      if (hits && hits.length) return hits[0].object;

      // æ²¡æœ‰å‘½ä¸­æ—¶ï¼šé€‰ç¦»å°„çº¿æœ€è¿‘çš„é‚£å¼ ï¼ˆç£å¸ï¼‰
      let best=null, bestD=1e9;
      const ro = raycaster.ray.origin;
      const rd = raycaster.ray.direction;
      for (const p of photoPlanes){
        const v = p.position.clone().sub(ro);
        const t = v.dot(rd);
        const closest = ro.clone().add(rd.clone().multiplyScalar(t));
        const d = p.position.distanceTo(closest);
        if (d<bestD){bestD=d; best=p;}
      }
      return bestD<0.55 ? best : null;
    }

    // ========= 8) åŠ¨ç”»å¾ªç¯ =========
    let tPrev=performance.now();
    function animate(now){
      const dt = Math.min(0.033, (now - tPrev)/1000);
      tPrev=now;

      // spread å¹³æ»‘
      spread += (targetSpread - spread) * (1 - Math.pow(0.0001, dt)); // æ—¶é—´æ— å…³å¹³æ»‘
      spread = clamp(spread, 0, 1);

      // åˆæ‹¢æ€ï¼šæ ‡å‡†èºæ—‹æ›´â€œè§„æ•´â€ï¼›æ•£å¼€æ€ï¼šèºæ—‹çº¿éšæ„æµåŠ¨
      if (helixGroup && helixGroup.children.length){
        // helixGroup.children[0] æ˜¯ tube
        const tube = helixGroup.children[0];
        if (tube && tube.geometry && tube.geometry.parameters){
          // è½»å¾®å‘¼å¸äº®åº¦
          tube.material.opacity = 0.55 + 0.12*Math.sin(now*0.0015);
        }
        // æ•£å¼€æ€ä¸‹ï¼šè®©æ•´æ¡ç¯ä¸²æ¼‚æµ®æ‘†åŠ¨
        const flow = spread;
        helixGroup.rotation.y = 0.18*Math.sin(now*0.0012)*flow;
        helixGroup.position.x = 0.18*Math.sin(now*0.0009)*flow;
        helixGroup.position.z = 0.14*Math.cos(now*0.0011)*flow;
      }

      // è£…é¥°çƒ & æ˜Ÿæ˜Ÿï¼šåœ¨ compact/scatter ä¹‹é—´æ’å€¼
      if (ornamentsGroup){
        ornamentsGroup.children.forEach((m, idx)=>{
          const a = smoothstep(spread);
          const p = m.userData.compact.clone().lerp(m.userData.scatter, a);
          // æ•£å¼€æ€æ¼‚æµ®
          p.y += spread*(0.10*Math.sin(now*0.001 + idx*0.7));
          m.position.copy(p);
        });
      }
      if (starMesh){
        const a = smoothstep(spread);
        const p = starMesh.userData.compact.clone().lerp(starMesh.userData.scatter, a);
        p.y += spread*(0.10*Math.sin(now*0.0012));
        starMesh.position.copy(p);
        starMesh.rotation.y += 0.01;
      }

      // æ ‘ä½“ & å…‰é›¾ï¼šæ•£å¼€æ€æ›´â€œæ•£â€ï¼Œåˆæ‹¢æ€æ›´â€œèšâ€
      if (treeGroup){
        treeGroup.scale.setScalar(1.0 - 0.08*spread);
        treeGroup.rotation.y += 0.002;
      }
      if (fogGroup){
        fogGroup.children.forEach((sp, i)=>{
          const a = spread;
          sp.position.x += 0.0025*Math.sin(now*0.0012 + i)*a;
          sp.position.z += 0.0020*Math.cos(now*0.0011 + i*1.2)*a;
          sp.material.opacity = (0.12 + 0.10*Math.sin(now*0.001 + i))*0.6 + 0.10;
        });
      }

      // ç…§ç‰‡ï¼šcompact/scatter æ’å€¼ + æœå‘é•œå¤´
      photoPlanes.forEach((p, i)=>{
        const a = smoothstep(spread);
        const target = p.userData.compact.clone().lerp(p.userData.scatter, a);
        // æ•£å¼€æ€è½»å¾®æ¼‚
        target.x += spread*(0.08*Math.sin(now*0.0015 + i*2.1));
        target.y += spread*(0.06*Math.cos(now*0.0013 + i*1.8));
        target.z += spread*(0.08*Math.cos(now*0.0014 + i*1.6));

        // PHOTO çŠ¶æ€ï¼šè¢«é€‰ä¸­çš„é‚£å¼ â€œç£å¸å±…ä¸­+å¼¹æ€§â€
        if (selectedPhoto && p===selectedPhoto){
          const center = camera.position.clone().add(camera.getWorldDirection(new THREE.Vector3()).multiplyScalar(2.2));
          // å¼¹æ€§ï¼šä½ç½®/ç¼©æ”¾ç”¨ spring
          const k = 1 - Math.pow(0.00001, dt);
          p.position.lerp(center, k);
          const s = 1.0 + 1.35*smoothstep( clamp((pinchHolding?1:0),0,1) );
          p.scale.lerp(new THREE.Vector3(s,s,s), k);
        }else{
          const k = 1 - Math.pow(0.00001, dt);
          p.position.lerp(target, k);
          p.scale.lerp(new THREE.Vector3(1,1,1), k);
        }

        // billboardï¼ˆä¿æŒæ­£é¢æ¸…æ™°ï¼‰
        p.lookAt(camera.position);
        p.material.opacity = (p.material.map ? 0.98 : 0.28);
      });

      // è§†è§’ï¼šyaw/pitch/rollï¼ˆæ›´çµæ•ã€è·Ÿéšå¹…åº¦ï¼‰
      const damp = 1 - Math.pow(0.0008, dt);
      yawVel *= (1 - 0.22*damp);
      pitchVel *= (1 - 0.22*damp);

      yaw += yawVel*dt;
      pitch += pitchVel*dt;
      pitch = clamp(pitch, -0.65, 0.55);

      const rDamp = 1 - Math.pow(0.003, dt);
      roll += (0 - roll)*rDamp;

      // ç›¸æœºç»•åŸç‚¹è½¬
      const radius = 5.2 - 1.15*spread;
      const cx = Math.sin(yaw)*radius;
      const cz = Math.cos(yaw)*radius;
      const cy = 1.15 + pitch*2.0;
      camera.position.set(cx, cy, cz);
      camera.lookAt(0, 0.35, 0);

      // è½»å¾® roll
      camera.rotation.z = roll;

      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    }

    // ========= 9) è§¦æ§/é¼ æ ‡æ‹–åŠ¨ï¼šé™çº§ä¹Ÿèƒ½è½¬ =========
    function onPointerDown(e){
      dragging=true;
      lastPX=e.clientX; lastPY=e.clientY;
    }
    function onPointerMove(e){
      if (!dragging) return;
      const dx = e.clientX-lastPX;
      const dy = e.clientY-lastPY;
      lastPX=e.clientX; lastPY=e.clientY;
      // æ‹–åŠ¨æ˜ å°„åˆ°é€Ÿåº¦ï¼šæ›´ä¸æ»‘
      yawVel   += dx * 0.010;
      pitchVel += dy * 0.008;
    }
    function onPointerUp(){
      dragging=false;
    }

    // ========= 10) æ‰‹åŠ¿é©±åŠ¨ï¼ˆæ›´çµæ•ï¼šç”¨â€œä½ç§»ç§¯åˆ†â€è€Œéç»å¯¹ä½ç½®ï¼‰ =========
    function handleHand(lm){
      if (!lm) return;

      const stable = updateStableGesture(lm);

      // å±å¹•åæ ‡ï¼ˆ0..1ï¼‰
      const palmX = (lm[0].x + lm[5].x + lm[17].x)/3;
      const palmY = (lm[0].y + lm[9].y + lm[13].y)/3;

      // rollï¼šæ ¹æ®æ‰‹æŒæ¨ªå‘éª¨æ¶è§’åº¦ï¼ˆè½»å¾®åŠ æˆï¼‰
      const a = lm[5], b = lm[17];
      const ang = Math.atan2((b.y-a.y), (b.x-a.x));
      roll = clamp( (ang*0.18), -0.15, 0.15 );

      if (stable===GEST.FIST){
        setState(STATE.COMPACT);
        selectedPhoto=null;
        pinchHolding=false;
        hidePhotoOverlay();
      }else if (stable===GEST.OPEN){
        if (state!==STATE.PHOTO) setState(STATE.SCATTER);
      }

      // æ•£å¼€æ€ï¼šç§»åŠ¨æ‰‹ â†’ æ—‹è½¬è§†è§’ï¼ˆå¹…åº¦è·Ÿéšï¼‰
      if ((state===STATE.SCATTER) && stable!==GEST.PINCH){
        if (lastHandX!=null){
          const dx = palmX - lastHandX;
          const dy = palmY - lastHandY;
          // å…³é”®ï¼šç§¯åˆ† â†’ æ‰‹ç§»åŠ¨ä¸€æ•´åœˆï¼Œè§†è§’å°±èƒ½è½¬ä¸€æ•´åœˆ
          yawVel   += dx * 6.2;  // çµæ•åº¦ï¼ˆæ›´è·Ÿæ‰‹ï¼‰
          pitchVel += dy * 4.6;
        }
      }

      // PINCHï¼šæŠ“å–ç…§ç‰‡ï¼ˆæ‹‡æŒ‡+é£ŸæŒ‡æåˆï¼‰
      if (stable===GEST.PINCH){
        if (!pinchHolding){
          pinchHolding=true;

          // é€‰ä¸€å¼ ï¼šæ ¹æ®æ‰‹åœ¨ç”»é¢ä¸­çš„ä½ç½® raycast
          const picked = pickPhotoByScreenXY(palmX, palmY);
          if (picked){
            selectedPhoto = picked;
            setState(STATE.PHOTO);

            const idx = picked.userData.index;
            const url = photoUrls[idx];
            if (url){
              showPhotoOverlay(url);
            }else{
              showToast("è¿™å¼ ç…§ç‰‡è¿˜æ²¡ä¸Šä¼ ï¼šè¯·å…ˆç‚¹â€œä¸Šä¼ ç…§ç‰‡(â‰¤7)â€é€‰æ‹©å›¾ç‰‡", 2600);
            }
          }
        }
      }else{
        // æåˆæ¾å¼€ï¼šå›åŸä½
        if (pinchHolding){
          pinchHolding=false;
          selectedPhoto=null;
          hidePhotoOverlay();
          // å›æ•£å¼€æ€ï¼ˆä¿æŒæ¼‚æµ®ï¼‰
          setState(STATE.SCATTER);
        }
      }

      lastHandX=palmX;
      lastHandY=palmY;
    }

    async function startHandTracking(){
      try{
        const base = await loadMediaPipeHands();
        const video = $("video");

        hands = new Hands({
          locateFile: (file)=> base + file
        });
        hands.setOptions({
          maxNumHands:1,
          modelComplexity:1,
          minDetectionConfidence:0.60,
          minTrackingConfidence:0.60
        });
        hands.onResults((res)=>{
          if (res && res.multiHandLandmarks && res.multiHandLandmarks[0]){
            lastLm = res.multiHandLandmarks[0];
            handleHand(lastLm);
          }
        });

        mpCamera = new Camera(video, {
          onFrame: async ()=>{ await hands.send({image: video}); },
          width:  640,
          height: 480
        });
        await mpCamera.start();
        handReady=true;
        updateDots();
        showToast("æ‰‹åŠ¿å·²å¯ç”¨ âœ…", 1200);
      }catch(e){
        handReady=false;
        updateDots();
        // ä¸å†æŒ¡å±ï¼Œåªæç¤ºä¸€ä¸‹
        showToast("æ‰‹åŠ¿åº“åŠ è½½å¤±è´¥ï¼šä»å¯ç”¨æ‰‹æŒ‡/é¼ æ ‡æ‹–åŠ¨æ—‹è½¬ï¼ˆå»ºè®®æ¢ç³»ç»Ÿæµè§ˆå™¨/æ¢ç½‘ç»œï¼‰", 4200);
      }
    }

    // ========= 11) è‡ªé€‚é… =========
    function onResize(){
      if (!renderer || !camera) return;
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);

      // ä¸åŒç«¯ï¼šæ ‘è· & è§†é‡å¾®è°ƒ
      const minDim = Math.min(innerWidth, innerHeight);
      const phone = minDim < 520;
      camera.fov = phone ? 58 : 52;
      camera.updateProjectionMatrix();
    }
    addEventListener("resize", onResize);

    // ========= 12) æŒ‰é’®é€»è¾‘ =========
    $("replayBtn").addEventListener("click", ()=>{
      tryPlayBGM();
    });
    $("recamBtn").addEventListener("click", async ()=>{
      await tryOpenCamera();
      if (!handReady) startHandTracking();
    });

    // ========= 13) å¯åŠ¨ï¼šå¤§æŒ‰é’®ä¸€æ¬¡å®Œæˆ =========
    $("startBig").addEventListener("click", async ()=>{
      try{
        // å…ˆä¿è¯ three
        if (!window.THREE){
          await ensureThree();
        }
        // åˆå§‹åŒ–æ¸²æŸ“ï¼ˆåªåšä¸€æ¬¡ï¼‰
        if (!scene){
          buildScene();
          onResize();

          // è§¦æ§/é¼ æ ‡
          renderer.domElement.addEventListener("pointerdown", onPointerDown, {passive:true});
          addEventListener("pointermove", onPointerMove, {passive:true});
          addEventListener("pointerup", onPointerUp, {passive:true});
          addEventListener("pointercancel", onPointerUp, {passive:true});

          requestAnimationFrame(animate);
        }

        // åŒæ—¶è¯·æ±‚éŸ³ä¹+æ‘„åƒå¤´
        const [bgmOk, camOk] = await Promise.all([
          tryPlayBGM(),
          tryOpenCamera()
        ]);

        // æ‰‹åŠ¿
        if (camOk){
          await startHandTracking();
        }else{
          handReady=false; updateDots();
        }

        // é»˜è®¤è¿›å…¥â€œåˆæ‹¢æ€â€
        setState(STATE.COMPACT);

        $("startOverlay").style.display="none";
      }catch(e){
        showToast(String(e.message||e), 5200);
      }
    });

    // ========= 14) é¡µé¢åŠ è½½å°±å…ˆå°è¯•åŠ è½½ Threeï¼ˆä¸å¼ºåˆ¶ï¼‰ =========
    (async ()=>{
      try{
        await ensureThree();
        // é¢„åŠ è½½æˆåŠŸåï¼Œä¸åšä»»ä½•è‡ªåŠ¨æ’­æ”¾/è‡ªåŠ¨æ‘„åƒå¤´ï¼ˆå¿…é¡»ç”¨æˆ·ç‚¹å‡»ï¼‰
      }catch(e){
        // ä¸æŒ¡ç•Œé¢ï¼Œè®©ç”¨æˆ·ç‚¹æŒ‰é’®åå†æç¤º
      }
    })();

    updateDots();
  })();
  </script>
</body>
</html>
